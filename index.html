<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Selda Mediterranean - Product Order Form</title>

    <!-- PWA Manifest, Tema ve İkonlar -->
    <link rel="manifest" href="./manifest.json"> <!-- Aynı dizindeki manifest.json'a işaret eder (android-chrome ikonları burada tanımlanmalı) -->
    <meta name="theme-color" content="#28a745">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png"> <!-- Aynı dizindeki apple-touch-icon.png'ye işaret eder -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Selda Mediterranean ürün sipariş formu uygulaması.">

    <!-- Favicon (Aynı dizindeki favicon.ico, favicon-16x16.png, favicon-32x32.png dosyalarının varlığından emin olun) -->
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <!-- Not: favicon-16x16.png ve favicon-32x32.png tarayıcılar tarafından otomatik olarak veya manifest.json üzerinden algılanabilir -->

    <!-- Kütüphaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> <!-- Integrity kaldırıldı -->

    <style>
        :root {
            --primary-color: #28a745;
            --banner-bg-color: #5cb85c;
            --secondary-color: #6c757d;
            --light-gray: #f4f7f6;
            --dark-gray: #333;
            --white: #fff;
            --border-color: #dee2e6;
            --border-radius-sm: 4px;
            --border-radius-md: 6px;
            --border-radius-lg: 10px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --input-bg-disabled: #e9ecef;
            --summary-total-bg: #f0f0f0;
            --button-blue-original: #007bff;
            --button-blue-original-hover: #0056b3;
        }
        body {font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--light-gray); color: var(--dark-gray); display: flex; flex-direction: column; align-items: center; min-height: 100vh;}
        #loginScreen {position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 1; visibility: visible; transition: opacity 0.5s ease, visibility 0.5s ease; overflow-y: auto;}
        #loginScreen.hidden {opacity: 0; visibility: hidden; pointer-events: none;}
        .login-container {background-color: var(--white); padding: 30px 40px; border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; width: 100%; max-width: 360px; box-sizing: border-box; margin: 20px;}
        #loginScreen h2 {color: var(--dark-gray); margin-top: 0; margin-bottom: 25px; font-size: 1.7em;}
        #loginScreen input[type="text"],
        #loginScreen input[type="password"] {width: calc(100% - 22px); padding: 12px 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-size: 1em; box-sizing: border-box;}
        #loginScreen input[type="text"]:focus,
        #loginScreen input[type="password"]:focus {border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);}
        .remember-me-container { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px; font-size: 0.9em; }
        .remember-me-container input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); }
        .remember-me-container label { cursor: pointer; color: #555; }
        #loginScreen button {background-color: var(--primary-color); color: var(--white); border: none; padding: 12px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 1.05em; font-weight: bold; margin-top: 10px; border-radius: var(--border-radius-sm); cursor: pointer; transition: background-color 0.3s ease; width: 100%;}
        #loginScreen button:hover {background-color: #1e7e34;}
        .login-error-message {color: #dc3545; font-size: 0.9em; margin-top: 10px; min-height: 1.2em;}
        .page-wrapper {display: flex; flex-direction: column; width: 100%; max-width: 1800px; padding: 20px; box-sizing: border-box; flex-grow: 1;}
        @media (min-width: 992px) {.page-wrapper {flex-direction: row; align-items: flex-start; justify-content: center;}}
        .main-content {flex-grow: 1; width: 100%;}
        .container {background-color: var(--white); padding: 30px 40px; border-radius: var(--border-radius-lg); box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box;}
        .page-header {text-align: center; margin-bottom: 20px; position: relative;}
        .page-header img {max-width: 160px; height: auto;}
        .language-selector {position: absolute; top: 5px; right: 5px; display: flex; gap: 5px;}
        .language-selector button {background-color: var(--secondary-color); color: var(--white); border: none; padding: 6px 9px; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.8em; font-weight: bold; transition: background-color 0.2s;}
        .language-selector button:hover,
        .language-selector button.active {background-color: var(--primary-color);}
        .main-title-button {background-color: var(--banner-bg-color); color: var(--white); padding: 15px; border-radius: var(--border-radius-md); text-align: center; font-size: 1.6em; font-weight: bold; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-transform: uppercase;}
        .section-title {background-color: var(--secondary-color); color: var(--white); padding: 10px 14px; border-radius: var(--border-radius-md); margin-top: 20px; margin-bottom: 0; font-size: 1.1em; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0; transition: background-color 0.3s ease;}
        .section-title:focus {outline: 2px solid var(--primary-color); outline-offset: 2px;}
        .section-title.has-selection {background-color: #5a9a68;}
        .category-title-text {flex-grow: 1;}
        .category-search-container {margin-left: 10px; display: flex; align-items: center;}
        .category-search-box {padding: 4px 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.7em; width: 80px; background-color: var(--white); color: var(--dark-gray); transition: width 0.2s ease-in-out, border-color 0.2s ease-in-out;}
        .category-search-box:focus {width: 120px; border-color: #555; outline: none;}
        .section-title .toggle-icon::before {content: '▼'; font-size: 0.8em; margin-left: 10px; transition: transform 0.3s ease;}
        .section-title.collapsed + .product-table-wrapper {max-height: 0; overflow: hidden; border-top: none;}
        .section-title.collapsed .toggle-icon::before {transform: rotate(-90deg);}
        .general-notes-title-styling {border-radius: var(--border-radius-md); border-bottom-left-radius: var(--border-radius-md) !important; border-bottom-right-radius: var(--border-radius-md) !important; cursor: default !important;}
        .general-notes-title-styling .toggle-icon,
        .general-notes-title-styling .category-search-container {display: none;}
        .product-table-wrapper {max-height: 2000px; overflow: hidden; transition: max-height 0.5s ease-in-out, border 0.3s ease; border: 1px solid #e9ecef; border-top: none; border-bottom-left-radius: var(--border-radius-md); border-bottom-right-radius: var(--border-radius-md); margin-bottom: 20px;}
        table.info-table, table.product-table {width: 100%; border-collapse: collapse;}
        .info-table th, .info-table td, .product-table th, .product-table td {border: 1px solid var(--border-color); padding: 7px 9px; text-align: left; vertical-align: top; word-break: break-word;}
        .product-table th {text-align: center; background-color: #f8f9fa;}
        .info-table th {background-color: #e9ecef; font-weight: 600; font-size: 0.9em; width: 220px; white-space: nowrap;}
        .branch-input-container {display: flex; align-items: center; gap: 10px; flex-wrap: nowrap;}
        .branch-input-container select {flex-grow: 1; min-width: 150px;}
        .branch-input-container input[type="checkbox"] {margin-left: auto; margin-right: 5px; transform: scale(1.2); flex-shrink: 0;}
        #manualBranchInput {width: calc(100% - 20px); margin-top: 8px; box-sizing: border-box;}
        .product-row.selected-row {background-color: #a7d7ae !important;}
        .product-row.selected-row td:first-child {color: var(--primary-color); font-weight: bold;}
        .product-row.hidden-by-search {display: none !important;}
        input[type="text"], input[type="date"], input[type="time"], input[type="email"], select, textarea {width: calc(100% - 20px); padding: 8px 10px; border: 1px solid #ced4da; border-radius: var(--border-radius-sm); box-sizing: border-box; font-size: 0.9em;}
        textarea {min-height: 70px;}
        input[type="number"].manual-qty-input {width: 60px; padding: 6px; text-align: center; margin-left: 5px; font-size: 0.85em; border: 1px solid #ced4da; border-radius: var(--border-radius-sm);}
        .quantity-options {display: flex; flex-direction: column; gap: 5px;}
        .quantity-options label {margin-right: 8px; font-size: 0.9em; display: inline-flex; align-items: center; cursor: pointer; padding: 4px 0;}
        .quantity-options label span.qty-label-text {margin-left: 4px;}
        .quantity-options input[type="checkbox"] {margin-right: 6px; transform: scale(1.2); cursor: pointer;}
        input[readonly], input[type="text"]:disabled, select:disabled {background-color: var(--input-bg-disabled); cursor: not-allowed;}
        .buttons-area {margin-top: 25px; text-align: right; padding-top: 15px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end;}
        .buttons-area button {color: var(--white); border: none; padding: 10px 18px; text-align: center; text-decoration: none; display: inline-block; font-size: 0.9em; font-weight: 500; border-radius: var(--border-radius-sm); cursor: pointer; transition: background-color 0.3s ease; flex-grow: 0;}
        .buttons-area button.print-btn {background-color: var(--primary-color);}
        .buttons-area button.print-btn:hover {background-color: #1e7e34;}
        .buttons-area button#sendEmailBtn {background-color: var(--secondary-color);}
        .buttons-area button#sendEmailBtn:hover {background-color: #545b62;}
        .buttons-area button.share-btn {background-color: var(--button-blue-original);}
        .buttons-area button.share-btn:hover {background-color: var(--button-blue-original-hover);}
        .page-footer {text-align: center; margin-top: auto; padding: 15px 0; border-top: 1px solid #eee; font-size: 0.85em; color: #777; width: 100%; background-color: var(--light-gray);}
        .developer-signature {text-align: center; font-size: 0.8em; color: #888; padding: 10px 0; width: 100%; background-color: var(--light-gray);}
        .order-summary-panel {width: 100%; max-width: 300px; min-width: 280px; background-color: #fdfdfd; border: 1px solid #ddd; border-radius: var(--border-radius-md); padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); align-self: flex-start; display: flex; flex-direction: column; transition: height 0.3s ease-out; margin-top: 20px;}
        @media (min-width: 992px) {.order-summary-panel {position: sticky; top: 20px; width: 320px; margin-top: 0; margin-left: 20px;}}
        .order-summary-panel h3 {margin-top: 0; font-size: 1.1em; color: var(--dark-gray); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 8px; flex-shrink: 0;}
        .order-summary-list-container {overflow-y: auto; max-height: 380px; margin-bottom: 10px; flex-grow: 1;}
        .order-summary-list {list-style: none; padding: 0; margin: 0;}
        .order-summary-list li {padding: 7px 0; font-size: 0.85em; border-bottom: 1px dashed #f0f0f0; display: flex; justify-content: space-between; align-items: center;}
        .order-summary-list li:last-child {border-bottom: none;}
        .summary-product-name {flex-grow: 1; margin-right: 8px; color: #444;}
        .summary-product-qty {font-weight: 600; white-space: nowrap; text-align: right; color: var(--primary-color);}
        .empty-summary {text-align: center; color: #888; font-style: italic; padding: 15px 0;}
        .summary-totals {margin-top: auto; padding: 8px; border-top: 1px solid #ccc; font-size: 0.9em; flex-shrink: 0; background-color: var(--summary-total-bg); border-radius: var(--border-radius-sm);}
        .summary-totals div {display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: 600;}
        .summary-totals div span:first-child {color: #555;}
        .summary-totals span:last-child {color: var(--dark-gray);}
        @media (max-width: 991px) {.container {padding: 20px 15px;} .main-title-button {font-size: 1.3em; padding: 12px;} .section-title {font-size: 1em; padding: 9px 12px;} .category-search-box {font-size: 0.7em; width: 70px;} .category-search-box:focus {width: 100px;} .info-table th, .info-table td, .product-table th, .product-table td {padding: 6px 7px; font-size: 0.85em;} .info-table th {width: auto; min-width: 110px; font-size: 0.8em; white-space: normal;} .info-table td {min-width: 140px;} .branch-input-container {flex-wrap: wrap;} input[type="text"], input[type="date"], input[type="time"], input[type="email"], select, textarea {font-size: 0.9em; padding: 8px 9px; width: 100%;} #manualBranchInput {width: 100%;} input[type="number"].manual-qty-input {width: 55px; font-size: 0.85em;} .quantity-options label {font-size: 0.85em;} .buttons-area {text-align: center; justify-content: center;} .buttons-area button {padding: 9px 15px; font-size: 0.85em; margin: 5px 5px 10px; width: calc(50% - 12px); min-width: 110px;} @media (max-width: 991px) and (min-width: 481px) {.buttons-area button {width: calc(33.33% - 10px);}} @media (max-width: 480px) {.buttons-area button {width: 100%; margin-left: 0; margin-right: 0;}} .order-summary-panel {max-width: 100%; min-width: unset; margin-left: 0; margin-top: 25px; border-radius: var(--border-radius-md);} .order-summary-list-container {max-height: 300px;} .order-summary-panel h3 {font-size: 1em;} .order-summary-list li {font-size: 0.8em;} .summary-totals {font-size: 0.85em;}}
        @media (max-width: 767px) {.page-header img {max-width: 140px;} .language-selector {top: 2px; right: 2px; gap: 3px;} .language-selector button {padding: 5px 7px; font-size: 0.75em;} .main-title-button {font-size: 1.1em;} .info-table, .info-table tbody, .info-table tr, .info-table td, .info-table th {display: block; width: 100% !important; box-sizing: border-box;} .info-table tr {margin-bottom: 10px;} .info-table th {text-align: left; border-bottom: none; background-color: var(--light-gray);} .info-table td {border-top: none;} .product-table th:nth-child(2), .product-table th:nth-child(3) {width: 100px !important; font-size: 0.8em;} .quantity-options {align-items: flex-start;}}
        @media (max-width: 480px) {.container {padding: 15px 10px;} .page-header img {max-width: 120px;} .login-container {padding: 25px 20px; max-width: 320px;} .category-search-box {width: 60px;} .category-search-box:focus {width: 90px;}}
        @media print {body {margin:0!important;padding:0!important;background-color:var(--white);font-family:Arial,sans-serif;font-size:9pt;color:#000;-webkit-print-color-adjust:exact;print-color-adjust:exact} #loginScreen,.page-wrapper,.order-summary-panel,.page-footer,.buttons-area,.main-title-button,.language-selector,.developer-signature,#shareOptionsModal{display:none!important} #printAreaContainer{display:block!important;margin:0 auto!important;padding:0!important;width:100%} #printAreaContent{margin:0;padding:0} #printAreaContent *,#printAreaContent *::before,#printAreaContent *::after{box-sizing:border-box} .print-header{text-align:center;margin-bottom:15px;border-bottom:2px solid #000;padding-bottom:8px} .print-logo{max-width:130px;height:auto;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto} #printAreaContent h1{font-size:14pt;font-weight:700;margin-top:5px;margin-bottom:10px;text-align:center;color:#333} .print-order-info{display:flex;justify-content:space-between;align-items:center;width:100%;margin-top:5px;font-size:9pt} .print-order-info span{margin:1px 0} .print-section{margin-bottom:10px} #printAreaContent h2{font-size:11pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:3px;margin-top:15px;margin-bottom:8px;text-align:left;color:#333} .print-info-compact .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:3px 15px;font-size:9pt} .print-info-compact .info-grid p{margin:2px 0} .print-product-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:8.5pt} .print-product-table th,.print-product-table td{border:1px solid #ccc;padding:4px 6px;text-align:left;word-break:break-word;overflow-wrap:break-word} .print-product-table th{background-color:#f0f0f0;font-weight:700;text-align:center} .print-product-table td{vertical-align:top} .print-product-table .product-name-col{width:50%} .print-product-table .qty-col{width:25%;text-align:center} .print-totals{margin-top:10px;padding-top:10px;border-top:1px solid #666;font-size:9pt} .print-totals p{margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline} .print-totals p span:first-child{margin-right:15px} .print-notes{border:none;border-top:1px solid #ccc;border-bottom:1px solid #ccc;padding:8px 0;min-height:40px;margin-top:5px;font-size:8.5pt;white-space:pre-wrap;word-break:break-word} .print-signatures-footer-group{page-break-inside:avoid!important;margin-top:auto} .print-signatures{margin-top:30px;display:flex;justify-content:space-between;font-size:8.5pt;align-items:flex-end} .signature-block-print{width:45%;text-align:center} .signature-block-print p{margin:0;padding-top:15px;border-top:1px solid #666} .print-footer{text-align:center;margin-top:20px;padding-top:8px;border-top:1px dashed #aaa;font-size:7.5pt;color:#555} .print-section,.print-product-table tbody tr{page-break-inside:avoid} @page{size:A4 portrait;margin:10mm}}
        .modal {display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center}
        .modal-content {background-color:#fefefe;margin:auto;padding:25px;border:1px solid #888;width:90%;max-width:450px;border-radius:var(--border-radius-md);box-shadow:0 5px 15px rgba(0,0,0,.3);text-align:center}
        .modal-content h4 {margin-top:0;color:var(--dark-gray)}
        .modal-content button {background-color:var(--primary-color);color:#fff;padding:10px 15px;margin:8px 5px;border:none;border-radius:var(--border-radius-sm);cursor:pointer;font-size:.9em}
        .modal-content button:hover {opacity:.9}
        .modal-content button.secondary {background-color:var(--secondary-color)}
        .close-modal-btn {background-color:#ccc;color:#333}
        .modal-message {font-size:.9em;color:#555;margin-bottom:15px;min-height:1.2em}
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <h2 id="loginTitle" data-translate="loginTitle">Giriş Yap</h2>
            <input type="text" id="username" data-translate-placeholder="usernamePlaceholder" placeholder="Kullanıcı Adı" autocomplete="username">
            <input type="password" id="password" data-translate-placeholder="passwordPlaceholder" placeholder="Şifre" autocomplete="current-password">
            <div class="remember-me-container">
                <input type="checkbox" id="rememberMeCheckbox">
                <label for="rememberMeCheckbox" id="rememberMeLabel" data-translate="rememberMeLabel">Beni Hatırla</label>
            </div>
            <button id="loginButton" data-translate="loginButtonText">GİRİŞ</button>
            <p id="loginError" class="login-error-message" style="display:none;"></p>
        </div>
    </div>

    <div class="page-wrapper" style="display: none;">
        <main class="main-content">
            <div class="container">
                <header class="page-header">
                    <img src="./logo.png" alt="Selda Mediterranean Logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/160x60?text=Selda+Logo'; this.alt='Placeholder Logo';" style="max-width: 160px; height: auto;"> <!-- LOGO GÜNCELLENDİ -->
                    <div class="language-selector">
                        <button id="langTrBtn">TR</button>
                        <button id="langEnBtn">EN</button>
                    </div>
                </header>
                <div class="main-title-button" data-translate="orderFormTitle">ÜRÜN SİPARİŞ FORMU</div>
                <form id="orderForm">
                    <table class="info-table">
                        <tr>
                            <th data-translate="orderNoLabel">Sipariş No:</th>
                            <td><input type="text" id="orderNo" readonly></td>
                            <th data-translate="orderDateLabel">Sipariş Tarihi:</th>
                            <td><input type="date" id="orderDate"></td>
                        </tr>
                        <tr>
                            <th data-translate="authorizedPersonLabel">Sipariş Veren Yetkili:</th>
                            <td><input type="text" id="orderSenderName" data-translate-placeholder="authPersonPlaceholder" placeholder="Adınız Soyadınız" required></td>
                            <th data-translate="branchNameLabel">Şube Adı:</th>
                            <td>
                                <div class="branch-input-container">
                                    <select id="branchSelect"></select>
                                    <input type="checkbox" id="manualBranchCheckbox" data-translate-title="manualBranchCheckboxTitle" title="Elle Şube Adı Gir">
                                </div>
                                <input type="text" id="manualBranchInput" data-translate-placeholder="manualBranchInputPlaceholder" placeholder="Şube adını buraya yazın..." style="display: none;">
                            </td>
                        </tr>
                        <tr>
                            <th data-translate="requestedDeliveryDateLabel">Talep Edilen Teslim Tarihi:</th>
                            <td><input type="date" id="deliveryDate"></td>
                            <th data-translate="contactPhoneLabel">İletişim Telefonu (Şube):</th>
                            <td><input type="text" id="contactPhone" data-translate-placeholder="contactPhonePlaceholder" placeholder="Şube telefon numarası"></td>
                        </tr>
                    </table>
                    <div id="productSectionsContainer"></div>
                    <div class="section-title general-notes-title-styling" style="margin-top:10px;" data-translate="generalNotesTitle">GENEL NOTLAR</div>
                    <textarea id="generalNotes" data-translate-placeholder="generalNotesPlaceholder" placeholder="Siparişle ilgili genel notlarınız..."></textarea>
                    <div class="buttons-area">
                        <button type="button" class="print-btn" data-translate="printButton">YAZDIR</button>
                        <button type="button" id="sendEmailBtn" data-translate="sendOrderButton">POSTA GÖNDER</button>
                        <button type="button" id="shareButton" class="share-btn" data-translate="shareButtonText">PAYLAŞ</button>
                    </div>
                </form>
            </div>
        </main>
        <aside class="order-summary-panel" id="orderSummaryPanel">
            <h3 data-translate="orderSummaryTitle">Sipariş Özeti</h3>
            <div class="order-summary-list-container" id="summaryListContainer">
                <ul class="order-summary-list" id="summaryList"></ul>
                <p class="empty-summary" id="emptySummaryText" data-translate="emptySummaryText">Henüz ürün seçilmedi.</p>
            </div>
            <div class="summary-totals" id="summaryTotals">
                <div><span data-translate="totalLbLabel">Toplam LB:</span> <span id="totalLb">0 LB</span></div>
                <div><span data-translate="totalPcsLabel">Toplam Adet:</span> <span id="totalAdet">0 Adet</span></div>
            </div>
        </aside>
    </div>
    <footer class="page-footer">
        <p><strong id="footerCompanyName" data-translate="footerCompanyName">Selda Mediterranean - Merkezi Mutfak</strong></p>
        <p>Adres: <span id="footerCompanyAddress"></span> | Telefon: <span id="footerCompanyPhone"></span></p>
    </footer>
    <div class="developer-signature"></div>
    <div id="printAreaContainer" style="display: none;">
        <div id="printAreaContent"></div>
    </div>

    <div id="shareOptionsModal" class="modal">
        <div class="modal-content">
            <h4 data-translate="shareModalTitle">Sipariş Formunu Paylaş</h4>
            <p id="shareModalMessage" class="modal-message" data-translate="shareModalMessage">PDF oluşturuluyor, lütfen bekleyin...</p>
            <div id="shareButtonsContainer" style="display:none;">
                <button id="downloadPdfButton" data-translate="downloadPdfButton">PDF İndir</button>
                <button id="downloadWordButton" data-translate="downloadWordButton">Word Olarak İndir</button>
            </div>
            <button id="closeShareModalButton" class="close-modal-btn" data-translate="closeButton">Kapat</button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        // ... (JavaScript kodunun geri kalanı değişmedi) ...
        let mainFormInitialized = false;

        const CORRECT_USERNAME = "Kitchen";
        const CORRECT_PASSWORD = "S8246";
        const AUTH_KEY_SESSION = 'seldaOrderForm_authenticated_v11_file_nologo_share_word';
        const LS_REMEMBER_USER = 'seldaOrderForm_rememberUser';
        const LS_REMEMBERED_USERNAME = 'seldaOrderForm_rememberedUsername';

        let loginScreen, usernameInput, passwordInput, rememberMeCheckbox, loginButton, loginError;
        let pageWrapper, orderSenderNameInput, contactPhoneInput, branchSelect, manualBranchCheckbox, manualBranchInput,
            orderDateInput, deliveryDateInput, orderNoInput, generalNotesInput,
            mainFormLangTrBtn, mainFormLangEnBtn,
            printButton, sendEmailBtn, shareButton,
            shareOptionsModal, closeShareModalButton, downloadPdfButton, downloadWordButton,
            shareModalMessage, shareButtonsContainer;

        const COMPANY_ADDRESS_PRINT = "14902 Preston Rd Ste 512A, TX 75254";
        const COMPANY_PHONE_PRINT = "214-377-7716";
        const EMAIL_RECIPIENT = "kadireymurus@gmail.com";

        const translations = {
            "tr": {
                "pageTitle": "Selda Mediterranean - Ürün Sipariş Formu", "orderFormTitle": "ÜRÜN SİPARİŞ FORMU",
                "orderNoLabel": "Sipariş No:", "orderDateLabel": "Sipariş Tarihi:",
                "authorizedPersonLabel": "Sipariş Veren Yetkili:", "authPersonPlaceholder": "Adınız Soyadınız",
                "branchNameLabel": "Şube Adı:", "manualBranchCheckboxTitle": "Elle Şube Adı Gir",
                "manualBranchInputPlaceholder": "Şube adını buraya yazın...",
                "requestedDeliveryDateLabel": "Talep Edilen Teslim Tarihi:",
                "contactPhoneLabel": "İletişim Telefonu (Şube):", "contactPhonePlaceholder": "Şube telefon numarası",
                "productNameHeader": "Ürün Adı", "lbHeader": "Pound (LB)", "pcsUnitHeader": "Adet",
                "otherLabel": "Diğer:", "generalNotesTitle": "GENEL NOTLAR",
                "generalNotesPlaceholder": "Siparişle ilgili genel notlarınız...",
                "printButton": "YAZDIR", "sendOrderButton": "POSTA GÖNDER", "shareButtonText": "PAYLAŞ",
                "orderSummaryTitle": "Sipariş Özeti", "emptySummaryText": "Henüz ürün seçilmedi.",
                "totalLbLabel": "Toplam LB:", "totalPcsLabel": "Toplam Adet:",
                "footerCompanyName": "Selda Mediterranean - Merkezi Mutfak",
                "alert_authPersonMissing": "Lütfen 'Sipariş Veren Yetkili' adını giriniz.",
                "alert_orderDateInvalid": "Lütfen geçerli bir 'Sipariş Tarihi' seçiniz.",
                "alert_deliveryDateInvalid": "Lütfen 'Talep Edilen Teslim Tarihi' seçiniz.",
                "alert_branchNameInvalid": "Lütfen geçerli bir 'Şube Adı' seçiniz veya giriniz.",
                "alert_noItemSelected": "Lütfen paylaşmadan/göndermeden önce en az bir ürün için miktar belirtin.",
                "searchPlaceholder": "Ara...",
                "manualBranchNotSpecified": "Belirtilmedi (Manuel)", "selectionBranchNotSpecified": "Belirtilmedi (Seçim)",
                "summaryUnitLB": "LB", "summaryUnitPCS": "Adet", "summaryUnitManual": "(M)",
                "loginTitle": "Giriş Yap", "usernamePlaceholder": "Kullanıcı Adı", "passwordPlaceholder": "Şifre",
                "loginButtonText": "GİRİŞ", "rememberMeLabel": "Beni Hatırla",
                "alert_loginFailed": "Kullanıcı adı veya şifre hatalı.",
                "alert_loginFieldsMissing": "Kullanıcı adı ve şifre alanları doldurulmalıdır.",
                "shareModalTitle": "Sipariş Formunu Paylaş",
                "shareModalMessage": "Dosya(lar) hazırlanıyor, lütfen bekleyin...",
                "shareModalMessageReady": "Dosya paylaşıma hazır veya aşağıdaki seçenekleri kullanın:",
                "downloadPdfButton": "PDF İndir", "downloadWordButton": "Word Olarak İndir",
                "wordGenerationFailed": "Word dosyası oluşturulamadı. Lütfen tekrar deneyin.",
                "pdfGenerationFailed": "PDF oluşturulamadı. Lütfen tekrar deneyin.",
                "closeButton": "Kapat",
                "webShareNotSupported": "Tarayıcınız doğrudan dosya paylaşımını desteklemiyor. Dosyayı indirip manuel olarak paylaşabilirsiniz."
            },
            "en": {
                "pageTitle": "Selda Mediterranean - Product Order Form", "orderFormTitle": "PRODUCT ORDER FORM",
                "orderNoLabel": "Order No:", "orderDateLabel": "Order Date:",
                "authorizedPersonLabel": "Authorized Person:", "authPersonPlaceholder": "Your Name",
                "branchNameLabel": "Branch Name:", "manualBranchCheckboxTitle": "Enter Branch Name Manually",
                "manualBranchInputPlaceholder": "Enter branch name here...",
                "requestedDeliveryDateLabel": "Requested Delivery Date:",
                "contactPhoneLabel": "Contact Phone (Branch):", "contactPhonePlaceholder": "Branch phone number",
                "productNameHeader": "Product Name", "lbHeader": "Pound (LB)", "pcsUnitHeader": "PCS",
                "otherLabel": "Other:", "generalNotesTitle": "GENERAL NOTES",
                "generalNotesPlaceholder": "Your general notes about the order...",
                "printButton": "PRINT", "sendOrderButton": "SEND E-MAIL", "shareButtonText": "SHARE",
                "orderSummaryTitle": "Order Summary", "emptySummaryText": "No products selected yet.",
                "totalLbLabel": "Total LB:", "totalPcsLabel": "Total PCS:",
                "footerCompanyName": "Selda Mediterranean - Central Kitchen",
                "alert_authPersonMissing": "Please enter the 'Authorized Person' name.",
                "alert_orderDateInvalid": "Please select a valid 'Order Date'.",
                "alert_deliveryDateInvalid": "Please select a 'Requested Delivery Date'.",
                "alert_branchNameInvalid": "Please select or enter a valid 'Branch Name'.",
                "alert_noItemSelected": "Please specify a quantity for at least one product before sharing/sending.",
                "searchPlaceholder": "Search...",
                "manualBranchNotSpecified": "Not Specified (Manual)", "selectionBranchNotSpecified": "Not Specified (Selection)",
                "summaryUnitLB": "LB", "summaryUnitPCS": "PCS", "summaryUnitManual": "(M)",
                "loginTitle": "Login", "usernamePlaceholder": "Username", "passwordPlaceholder": "Password",
                "loginButtonText": "LOGIN", "rememberMeLabel": "Remember Me",
                "alert_loginFailed": "Invalid username or password.",
                "alert_loginFieldsMissing": "Username and password fields must be filled.",
                "shareModalTitle": "Share Order Form",
                "shareModalMessage": "Generating file(s), please wait...",
                "shareModalMessageReady": "File is ready for sharing or use options below:",
                "downloadPdfButton": "Download PDF", "downloadWordButton": "Download as Word",
                "wordGenerationFailed": "Failed to generate Word file. Please try again.",
                "pdfGenerationFailed": "Failed to generate PDF. Please try again.",
                "closeButton": "Close",
                "webShareNotSupported": "Your browser does not support direct file sharing. You can download the file and share it manually."
            }
        };
        let currentLanguage = 'en';

        const productData = {
            "SMALL BITES": ["Soup of the Day", "Hummus", "Grilled Eggplant Salad", "Tzatziki (Cacik)", "Spicy Ezme", "Saksuka", "Turkish Feta and Olives", "Cigar Borek", "Shishito Peppers", "Halloumi Cheese", "Stuffed Dates", "Falafel", "Fried Cauliflower", "Salmon and Grape Leaves", "Arnavut Cigeri", "Shrimp Garlic", "Cheese and Meat Platter"],
            "A LITTLE MORE": ["Vegetarian Couscous", "Chicken Shish", "Chicken Adana", "Urfa Kebab", "Beef Shish", "Grilled Pistachio Meatballs", "Beyti Special", "Lamb Chops", "Lamb Shank", "Grilled Salmon", "Mixed Grill (2-4 Guests)", "Grilled Branzino", "Ali Nazik", "Lamb Shish"],
            "FROM THE OVEN": ["Vegetarian Pide", "Cheese Pide", "Meat Pide", "Spinach Feta Pide", "Lahmacun"],
            "DESSERT": ["Baklava", "Turkish Flan", "Chocolate Mousse", "Kunefe"]
        };
        const BRANCH_OPTIONS = [ "SELDA - Belt Line", "SELDA - The Mayor's", "SELDA - San Antonio", "SELDA - Frisco", "SELDA - Doner" ];

        const LS_LANGUAGE = 'seldaOrderForm_language_v1';
        const LS_SENDER_NAME = 'seldaOrderForm_senderName_v5';
        const LS_CONTACT_PHONE = 'seldaOrderForm_contactPhone_v5';
        const LS_BRANCH_SELECT_VALUE = 'seldaOrderForm_branchSelectValue_v5';
        const LS_MANUAL_BRANCH_VALUE = 'seldaOrderForm_manualBranchValue_v5';
        const LS_MANUAL_BRANCH_ENABLED = 'seldaOrderForm_manualBranchEnabled_v5';
        const LS_ORDER_DATE = 'seldaOrderForm_orderDate_v5';
        const LS_DELIVERY_DATE = 'seldaOrderForm_deliveryDate_v5';
        const LS_ORDER_COUNTER = 'seldaOrderCounterV13';

        function assignLoginDOMElements() {
            loginScreen = document.getElementById('loginScreen');
            usernameInput = document.getElementById('username');
            passwordInput = document.getElementById('password');
            rememberMeCheckbox = document.getElementById('rememberMeCheckbox');
            loginButton = document.getElementById('loginButton');
            loginError = document.getElementById('loginError');
            pageWrapper = document.querySelector('.page-wrapper');
        }

        function assignMainFormDOMElements() {
            orderSenderNameInput = document.getElementById('orderSenderName');
            contactPhoneInput = document.getElementById('contactPhone');
            branchSelect = document.getElementById('branchSelect');
            manualBranchCheckbox = document.getElementById('manualBranchCheckbox');
            manualBranchInput = document.getElementById('manualBranchInput');
            orderDateInput = document.getElementById('orderDate');
            deliveryDateInput = document.getElementById('deliveryDate');
            orderNoInput = document.getElementById('orderNo');
            generalNotesInput = document.getElementById('generalNotes');
            mainFormLangTrBtn = document.getElementById('langTrBtn');
            mainFormLangEnBtn = document.getElementById('langEnBtn');
            printButton = document.querySelector('.print-btn');
            sendEmailBtn = document.getElementById('sendEmailBtn');
            shareButton = document.getElementById('shareButton');
            shareOptionsModal = document.getElementById('shareOptionsModal');
            closeShareModalButton = document.getElementById('closeShareModalButton');
            downloadPdfButton = document.getElementById('downloadPdfButton');
            downloadWordButton = document.getElementById('downloadWordButton');
            shareModalMessage = document.getElementById('shareModalMessage');
            shareButtonsContainer = document.getElementById('shareButtonsContainer');
        }

        function showLoginScreen() {
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (pageWrapper) pageWrapper.style.display = 'none';
            if (usernameInput) usernameInput.focus();
        }

        function showMainForm() {
            if (loginScreen) loginScreen.classList.add('hidden');
            if (pageWrapper) pageWrapper.style.display = 'flex';
        }

        function checkAuth() {
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith('seldaOrderForm_authenticated_') && key !== AUTH_KEY_SESSION) {
                    sessionStorage.removeItem(key);
                }
            }
            if (sessionStorage.getItem(AUTH_KEY_SESSION) === 'true') {
                showMainForm();
                if (!mainFormInitialized) {
                    initializeMainForm();
                }
                return true;
            }
            showLoginScreen();
            return false;
        }

        function handleLogin() {
            const enteredUsername = usernameInput.value.trim();
            const enteredPassword = passwordInput.value.trim();
            const langSet = translations[currentLanguage] || translations.tr;

            if (!enteredUsername || !enteredPassword) {
                loginError.textContent = langSet.alert_loginFieldsMissing;
                loginError.style.display = 'block';
                return;
            }

            if (enteredUsername === CORRECT_USERNAME && enteredPassword === CORRECT_PASSWORD) {
                sessionStorage.setItem(AUTH_KEY_SESSION, 'true');
                loginError.style.display = 'none';

                if (rememberMeCheckbox.checked) {
                    try {
                        localStorage.setItem(LS_REMEMBER_USER, 'true');
                        localStorage.setItem(LS_REMEMBERED_USERNAME, enteredUsername);
                    } catch (e) { console.warn("localStorage 'Beni Hatırla' kaydı başarısız:", e); }
                } else {
                    try {
                        localStorage.removeItem(LS_REMEMBER_USER);
                        localStorage.removeItem(LS_REMEMBERED_USERNAME);
                    } catch (e) { console.warn("localStorage 'Beni Hatırla' silme başarısız:", e); }
                }
                showMainForm();
                if (!mainFormInitialized) {
                     initializeMainForm();
                }
            } else {
                loginError.textContent = langSet.alert_loginFailed;
                loginError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function loadRememberMe() {
            try {
                const rememberUser = localStorage.getItem(LS_REMEMBER_USER);
                if (rememberUser === 'true') {
                    const rememberedUsername = localStorage.getItem(LS_REMEMBERED_USERNAME);
                    if (rememberedUsername && usernameInput) {
                        usernameInput.value = rememberedUsername;
                    }
                    if (rememberMeCheckbox) {
                        rememberMeCheckbox.checked = true;
                    }
                    if(passwordInput && usernameInput.value) passwordInput.focus();
                } else {
                    if (rememberMeCheckbox) {
                        rememberMeCheckbox.checked = false;
                    }
                }
            } catch (e) {
                console.warn("localStorage 'Beni Hatırla' okuma başarısız:", e);
            }
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            try { localStorage.setItem(LS_LANGUAGE, lang); } catch(e) { console.warn("localStorage dil kaydı başarısız:", e); }
            if (document.documentElement) document.documentElement.lang = lang;
            updateUIForLanguage(lang);
            if (mainFormInitialized && mainFormLangTrBtn && mainFormLangEnBtn) {
                mainFormLangTrBtn.classList.toggle('active', lang === 'tr');
                mainFormLangEnBtn.classList.toggle('active', lang === 'en');
            }
        }

        function updateUIForLanguage(lang) {
            const translationSet = translations[lang] || translations.tr;
            if (!translationSet) return;
            if(document) document.title = translationSet.pageTitle;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translationSet[key]) el.textContent = translationSet[key];
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                if (translationSet[key]) el.placeholder = translationSet[key];
            });
            document.querySelectorAll('[data-translate-title]').forEach(el => {
                const key = el.dataset.translateTitle;
                if (translationSet[key]) el.title = translationSet[key];
            });

            if (loginError && loginError.style.display !== 'none') {
                 if (loginError.textContent.includes("hatalı") || loginError.textContent.includes("Invalid")) {
                     loginError.textContent = translationSet.alert_loginFailed;
                 } else if (loginError.textContent.includes("doldurulmalıdır") || loginError.textContent.includes("must be filled")) {
                     loginError.textContent = translationSet.alert_loginFieldsMissing;
                 }
            }

            if (mainFormInitialized) {
                renderProducts();
                updateOrderSummary();
            }
        }

        function loadLanguage() {
            let savedLang = 'tr';
            try { savedLang = localStorage.getItem(LS_LANGUAGE) || 'tr'; } catch(e) { console.warn("localStorage dil okuma başarısız:", e); }
            setLanguage(savedLang);
        }

        function formatDateForInput(date) {
            if (!(date instanceof Date) || isNaN(date.valueOf())) date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString, locale = 'en-US') {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                if (!isNaN(dateObj.getTime())) {
                    return dateObj.toLocaleDateString(locale, { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
            }
            return 'N/A';
        }

        function renderProducts() {
            const container = document.getElementById('productSectionsContainer');
            if (!container) return;
            let htmlContent = '';
            const langSet = translations[currentLanguage] || translations.tr;
            Object.keys(productData).forEach((category) => {
                const categoryId = `category-${category.replace(/\s+/g, '').toLowerCase()}`;
                htmlContent += `
                    <div class="section-title collapsed" role="button" tabindex="0" data-category-id="${categoryId}" aria-expanded="false" aria-controls="${categoryId}">
                        <span class="category-title-text">${category.toUpperCase()}</span>
                        <div class="category-search-container">
                            <input type="text" class="category-search-box" placeholder="${langSet.searchPlaceholder}" onclick="event.stopPropagation();">
                        </div>
                        <span class="toggle-icon" aria-hidden="true"></span>
                    </div>
                    <div class="product-table-wrapper" id="${categoryId}">
                        <table class="product-table">
                            <thead><tr><th>${langSet.productNameHeader}</th><th style="width: 200px;">${langSet.lbHeader}</th><th style="width: 200px;">${langSet.pcsUnitHeader}</th></tr></thead>
                            <tbody>`;
                productData[category].forEach(productName => {
                    const safeProductName = productName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
                    const baseId = `prod-${category.replace(/\s+/g, '')}-${safeProductName}`;
                    htmlContent += `
                                <tr class="product-row" data-product-name="${productName.toLowerCase()}" data-category-title-id="${categoryId}" id="row-${baseId}">
                                    <td>${productName}</td>
                                    <td><div class="quantity-options" data-unit="LB">
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="5"> 5</label> <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="10"> 10</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="15"> 15</label> <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="20"> 20</label>
                                        <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-lb-manual" min="0" step="any"></label>
                                    </div></td>
                                    <td><div class="quantity-options" data-unit="Adet">
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="50"> 50</label> <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="100"> 100</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="150"> 150</label> <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="200"> 200</label>
                                        <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                                    </div></td></tr>`;
                });
                htmlContent += '</tbody></table></div>';
            });
            container.innerHTML = htmlContent;
            attachProductEventListeners();
        }

        function updateOrderSummary() {
            const summaryList = document.getElementById('summaryList');
            const emptySummaryText = document.getElementById('emptySummaryText');
            const totalLbEl = document.getElementById('totalLb');
            const totalAdetEl = document.getElementById('totalAdet');
            if(!summaryList || !emptySummaryText || !totalLbEl || !totalAdetEl) return;

            const langSet = translations[currentLanguage] || translations.tr;
            summaryList.innerHTML = '';
            let hasItemsInSummary = false; let currentTotalLb = 0; let currentTotalAdet = 0;
            document.querySelectorAll('.section-title[data-category-id]').forEach(title => title.classList.remove('has-selection'));

            document.querySelectorAll('.product-row').forEach(row => {
                const productName = row.querySelector('td:first-child').textContent;
                const categoryId = row.dataset.categoryTitleId;
                const categoryTitleElement = document.querySelector(`.section-title[data-category-id="${categoryId}"]`);
                let summaryDetail = ''; let isRowSelected = false; let rowLb = 0; let rowAdet = 0;

                const lbOptions = row.querySelector('td:nth-child(2) .quantity-options');
                lbOptions.querySelectorAll('input.qty-cb:checked').forEach(cb => { const val = parseFloat(cb.value); summaryDetail += `${val} ${langSet.summaryUnitLB} `; rowLb += val; isRowSelected = true; });
                const lbManual = lbOptions.querySelector('.manual-qty-input');
                if (lbManual && lbManual.value && parseFloat(lbManual.value) > 0) { const val = parseFloat(lbManual.value); summaryDetail += `${val} ${langSet.summaryUnitLB} ${langSet.summaryUnitManual} `; rowLb += val; isRowSelected = true;}

                const adetOptions = row.querySelector('td:nth-child(3) .quantity-options');
                adetOptions.querySelectorAll('input.qty-cb:checked').forEach(cb => { const val = parseInt(cb.value); summaryDetail += `${val} ${langSet.summaryUnitPCS} `; rowAdet += val; isRowSelected = true; });
                const adetManual = adetOptions.querySelector('.manual-qty-input');
                if (adetManual && adetManual.value && parseInt(adetManual.value) > 0) { const val = parseInt(adetManual.value); summaryDetail += `${val} ${langSet.summaryUnitPCS} ${langSet.summaryUnitManual} `; rowAdet += val; isRowSelected = true;}

                if (isRowSelected) {
                    row.classList.add('selected-row');
                    if (categoryTitleElement) categoryTitleElement.classList.add('has-selection');
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="summary-product-name">${productName}</span> <span class="summary-product-qty">${summaryDetail.trim()}</span>`;
                    summaryList.appendChild(listItem);
                    hasItemsInSummary = true; currentTotalLb += rowLb; currentTotalAdet += rowAdet;
                } else { row.classList.remove('selected-row'); }
            });
            emptySummaryText.style.display = hasItemsInSummary ? 'none' : 'block';
            totalLbEl.textContent = `${currentTotalLb.toFixed(2)} ${langSet.summaryUnitLB}`;
            totalAdetEl.textContent = `${currentTotalAdet} ${langSet.summaryUnitPCS}`;
        }

        function attachProductEventListeners() {
            document.querySelectorAll('.section-title[data-category-id]').forEach((title) => {
                const toggleCategory = () => { title.classList.toggle('collapsed'); title.setAttribute('aria-expanded', !title.classList.contains('collapsed')); };
                title.addEventListener('click', (event) => { if (!event.target.classList.contains('category-search-box')) toggleCategory(); });
                title.addEventListener('keydown', (event) => { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); if (!event.target.classList.contains('category-search-box')) toggleCategory();}});

                const searchBox = title.querySelector('.category-search-box');
                const productTableWrapper = document.getElementById(title.dataset.categoryId);
                if (searchBox && productTableWrapper) {
                    searchBox.addEventListener('keyup', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        const productRows = productTableWrapper.querySelectorAll('.product-row');
                        let foundInThisCategory = false;
                        productRows.forEach(row => {
                            const productName = row.dataset.productName;
                            if (productName.includes(searchTerm)) { row.classList.remove('hidden-by-search'); foundInThisCategory = true; }
                            else { row.classList.add('hidden-by-search'); }
                        });
                        if (searchTerm !== "" && foundInThisCategory && title.classList.contains('collapsed')) { toggleCategory(); }
                    });
                }
            });
            document.querySelectorAll('.quantity-options input.qty-cb, .manual-qty-input').forEach(input => {
                const eventType = input.type === 'checkbox' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    const group = this.closest('.quantity-options');
                    if (this.type === 'checkbox' && this.checked) {
                        group.querySelectorAll('input.qty-cb').forEach(otherCb => { if (otherCb !== this) otherCb.checked = false; });
                        const manualInput = group.querySelector('.manual-qty-input'); if(manualInput) manualInput.value = '';
                    } else if (this.classList.contains('manual-qty-input') && this.value && ( (this.step === "any" && parseFloat(this.value) > 0) || (this.step === "1" && parseInt(this.value) > 0) ) ) {
                         group.querySelectorAll('input.qty-cb').forEach(cb => { cb.checked = false; });
                    }
                    updateOrderSummary();
                });
            });
        }

        function populateBranchSelect() { if(!branchSelect) return; branchSelect.innerHTML = ''; BRANCH_OPTIONS.forEach(text => { const opt = document.createElement('option'); opt.value = text; opt.textContent = text; branchSelect.appendChild(opt); });}
        function updateBranchInputState() { if(!manualBranchCheckbox || !manualBranchInput || !branchSelect) return; const isManual = manualBranchCheckbox.checked; manualBranchInput.style.display = isManual ? 'block' : 'none'; manualBranchInput.disabled = !isManual; branchSelect.disabled = isManual;}
        function getCurrentBranchName() { const langSet = translations[currentLanguage] || translations.tr; if(!manualBranchCheckbox || !manualBranchInput || !branchSelect) return langSet.selectionBranchNotSpecified; if (manualBranchCheckbox.checked) return manualBranchInput.value.trim() || langSet.manualBranchNotSpecified; return branchSelect.value || langSet.selectionBranchNotSpecified;}

        function saveFormSetting(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.warn(`localStorage '${key}' kaydı başarısız:`, e); }}
        function loadFormSettings() {
            if(!mainFormInitialized) return;
            try {
                orderSenderNameInput.value = localStorage.getItem(LS_SENDER_NAME) || '';
                contactPhoneInput.value = localStorage.getItem(LS_CONTACT_PHONE) || '';
                const savedBranch = localStorage.getItem(LS_BRANCH_SELECT_VALUE); if (savedBranch && branchSelect) branchSelect.value = savedBranch;
                if(manualBranchInput) manualBranchInput.value = localStorage.getItem(LS_MANUAL_BRANCH_VALUE) || '';
                if(manualBranchCheckbox) manualBranchCheckbox.checked = localStorage.getItem(LS_MANUAL_BRANCH_ENABLED) === 'true';
            } catch (e) { console.warn("localStorage ayarları yüklenirken hata:", e); }
            updateBranchInputState();
        }

        function setInitialDates() {
            if(!mainFormInitialized || !orderDateInput || !deliveryDateInput) return;

            // 1. Sipariş Tarihi (orderDateInput):
            // Her zaman sayfa yüklendiğinde o anki güncel tarih ile başlasın.
            // Kullanıcı bu tarihi manuel olarak değiştirdiğinde, bu değişiklik
            // initializeMainForm içindeki 'change' event listener tarafından LS_ORDER_DATE anahtarıyla localStorage'a kaydedilecektir.
            orderDateInput.value = formatDateForInput(new Date());

            // 2. Talep Edilen Teslim Tarihi (deliveryDateInput):
            // Bu alan için mevcut davranış korunacak: Eğer localStorage'da kayıtlı bir değer varsa o kullanılacak,
            // yoksa sipariş tarihinden (ki bu artık güncel tarih oldu) bir gün sonrası hesaplanıp
            // hem input'a atanacak hem de localStorage'a (LS_DELIVERY_DATE) kaydedilecek.
            let savedDeliveryDate = null;
            try {
                savedDeliveryDate = localStorage.getItem(LS_DELIVERY_DATE);
            } catch (e) { console.warn("localStorage teslim tarihi okuma hatası:", e); }

            if (savedDeliveryDate && savedDeliveryDate !== "undefined" && savedDeliveryDate !== "null") {
                // Eğer localStorage'da geçerli bir kayıtlı teslim tarihi varsa onu kullan.
                deliveryDateInput.value = savedDeliveryDate;
            } else {
                // Eğer localStorage'da kayıtlı teslim tarihi yoksa veya geçersizse,
                // o anki sipariş tarihinden (ki bu üst satırlarda güncel tarih olarak ayarlandı) bir gün sonrasını ata.
                let orderDateVal;
                // orderDateInput.value'dan tarihi parse et
                const orderDateParts = orderDateInput.value.split('-');
                if (orderDateParts.length === 3) {
                    orderDateVal = new Date(parseInt(orderDateParts[0]), parseInt(orderDateParts[1]) - 1, parseInt(orderDateParts[2]));
                }

                // orderDateVal'ın geçerli olup olmadığını kontrol et, değilse yine de new Date() kullan (temel olarak güncel tarih).
                const baseDateForDelivery = (orderDateVal && !isNaN(orderDateVal.getTime())) ? orderDateVal : new Date();
                const tomorrow = new Date(baseDateForDelivery);
                tomorrow.setDate(baseDateForDelivery.getDate() + 1);
                deliveryDateInput.value = formatDateForInput(tomorrow);

                // Bu hesaplanan ilk varsayılan teslim tarihi localStorage'a kaydedilsin.
                // Kullanıcı daha sonra manuel olarak değiştirirse, 'change' event listener'ı
                // LS_DELIVERY_DATE değerini güncelleyecektir.
                saveFormSetting(LS_DELIVERY_DATE, deliveryDateInput.value);
            } else { deliveryDateInput.value = savedDeliveryDate; }
        }

        function setFooterInfo() { if(!mainFormInitialized) return; const addr = document.getElementById('footerCompanyAddress'); const phone = document.getElementById('footerCompanyPhone'); if(addr) addr.textContent = COMPANY_ADDRESS_PRINT; if(phone) phone.textContent = COMPANY_PHONE_PRINT;}
        function setDeveloperSignature() { if(!mainFormInitialized) return; const devSign = document.querySelector('.developer-signature'); if (devSign) devSign.innerHTML = `Developed by K.E.`;}

        function validateOrderForm() {
            const langSet = translations[currentLanguage] || translations.tr;
            if (!orderSenderNameInput.value.trim()) { alert(langSet.alert_authPersonMissing); orderSenderNameInput.focus(); return false; }
            if (!orderDateInput.value || formatDateForDisplay(orderDateInput.value) === 'N/A') { alert(langSet.alert_orderDateInvalid); orderDateInput.focus(); return false; }
            if (!deliveryDateInput.value || formatDateForDisplay(deliveryDateInput.value) === 'N/A') { alert(langSet.alert_deliveryDateInvalid); deliveryDateInput.focus(); return false; }
            const currentBranch = getCurrentBranchName();
            if (!currentBranch || currentBranch === langSet.manualBranchNotSpecified || currentBranch === langSet.selectionBranchNotSpecified) { alert(langSet.alert_branchNameInvalid); if (manualBranchCheckbox.checked) manualBranchInput.focus(); else branchSelect.focus(); return false; }
            if (document.querySelectorAll('#summaryList li').length === 0) { alert(langSet.alert_noItemSelected); return false; }
            return true;
        }

        function getOrderDetails(forTextSummary = false) {
            const langSet = translations[currentLanguage] || translations.tr;
            const details = {
                orderNo: orderNoInput ? orderNoInput.value : 'N/A',
                orderDate: orderDateInput ? orderDateInput.value : '',
                senderName: orderSenderNameInput ? (orderSenderNameInput.value.trim() || 'N/A') : 'N/A',
                branchName: getCurrentBranchName().replace(langSet.manualBranchNotSpecified, "Not Specified (Manual)").replace(langSet.selectionBranchNotSpecified, "Not Specified (Selection)"),
                contactPhone: contactPhoneInput ? (contactPhoneInput.value.trim() || 'N/A') : 'N/A',
                deliveryDate: deliveryDateInput ? deliveryDateInput.value : '',
                generalNotes: generalNotesInput ? (generalNotesInput.value.trim() || (forTextSummary ? 'None' : '')) : (forTextSummary ? 'None' : ''),
                totalLbText: document.getElementById('totalLb') ? document.getElementById('totalLb').textContent : `0 ${langSet.summaryUnitLB}`,
                totalPcsText: document.getElementById('totalAdet') ? document.getElementById('totalAdet').textContent : `0 ${langSet.summaryUnitPCS}`,
                summaryItems: Array.from(document.querySelectorAll('#summaryList li')).map(item => ({
                    name: item.querySelector('.summary-product-name').textContent,
                    quantity: item.querySelector('.summary-product-qty').textContent
                }))
            };
            const displayLocale = currentLanguage === 'tr' ? 'tr-TR' : 'en-US';
            details.formattedOrderDate = formatDateForDisplay(details.orderDate, 'en-US');
            details.displayOrderDate = formatDateForDisplay(details.orderDate, displayLocale);
            details.formattedDeliveryDate = formatDateForDisplay(details.deliveryDate, 'en-US');
            details.displayDeliveryDate = formatDateForDisplay(details.deliveryDate, displayLocale);
            return details;
        }

        function generatePrintContent(forPdfOrWord = false) {
            const details = getOrderDetails();
            const langSet = translations[currentLanguage] || translations.tr;
            const companyNamePrint = translations['en'].footerCompanyName;
            const captureContainerWidth = forPdfOrWord ? '210mm' : '195mm';
            const containerPadding = forPdfOrWord ? '10mm' : '0';
            let logoSrcToUse = '';
            const logoImgElement = document.querySelector('.page-header img');
            if (logoImgElement) {
                if (logoImgElement.src.startsWith('data:image') || logoImgElement.src.includes('via.placeholder.com')) {
                    logoSrcToUse = logoImgElement.src;
                } else if (logoImgElement.complete && logoImgElement.naturalWidth !== 0) {
                    logoSrcToUse = logoImgElement.src;
                } else {
                    logoSrcToUse = 'https://via.placeholder.com/160x60?text=Selda+Logo';
                }
            } else {
                 logoSrcToUse = 'https://via.placeholder.com/160x60?text=Selda+Logo';
            }

            let productRowsHtml = '';
            if (details.summaryItems.length > 0) {
                details.summaryItems.forEach(item => {
                    const productName = item.name;
                    const productQtyText = item.quantity;
                    let lbQty = '-'; let pcsQty = '-';
                    const lbRegex = new RegExp(`([\\d\\.]+)\\s*(${langSet.summaryUnitLB.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}|LB)`);
                    const pcsRegex = new RegExp(`(\\d+)\\s*(${langSet.summaryUnitPCS.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}|PCS|Adet)`);
                    const lbMatch = productQtyText.match(lbRegex); if (lbMatch) lbQty = lbMatch[1];
                    const pcsMatch = productQtyText.match(pcsRegex); if (pcsMatch) pcsQty = pcsMatch[1];
                    if (lbMatch && productQtyText.includes(langSet.summaryUnitManual)) lbQty += " (M)";
                    if (pcsMatch && productQtyText.includes(langSet.summaryUnitManual)) pcsQty += " (M)";
                    productRowsHtml += `<tr><td class="product-name-col">${productName}</td><td class="qty-col">${lbQty}</td><td class="qty-col">${pcsQty}</td></tr>`;
                });
            } else { productRowsHtml = '<tr><td colspan="3" style="text-align:center;">No products ordered.</td></tr>'; }

            const printHTML = `
                <div id="captureForPdfOrWord" style="width:${captureContainerWidth};margin:0 auto;padding:${containerPadding};background:white;font-family:Arial,sans-serif;font-size:9pt;color:#000;box-sizing:border-box;">
                <header class="print-header" style="box-sizing:border-box;">
                    ${logoSrcToUse?`<img src="${logoSrcToUse}" alt="Selda Mediterranean Logo" class="print-logo" style="max-width:130px;height:auto;margin-bottom:8px;display:block;margin-left:auto;margin-right:auto;">`:''}
                    <h1 style="font-size:14pt;font-weight:700;margin-top:5px;margin-bottom:10px;text-align:center;color:#333;">PRODUCT ORDER FORM</h1>
                    <div class="print-order-info" style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-top:5px;font-size:9pt;box-sizing:border-box;">
                        <span style="margin:1px 0;"><strong>Order No:</strong> ${details.orderNo}</span>
                        <span style="margin:1px 0;"><strong>Order Date:</strong> ${details.formattedOrderDate}</span>
                    </div>
                </header>
                <section class="print-section" style="margin-bottom:10px;box-sizing:border-box;">
                    <h2 style="font-size:11pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:3px;margin-top:15px;margin-bottom:8px;text-align:left;color:#333;">BRANCH INFORMATION</h2>
                    <div class="print-info-compact"><div class="info-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:3px 15px;font-size:9pt;box-sizing:border-box;">
                        <p style="margin:2px 0;"><strong>Branch Name:</strong> ${details.branchName}</p>
                        <p style="margin:2px 0;"><strong>Authorized Person:</strong> ${details.senderName}</p>
                        <p style="margin:2px 0;"><strong>Contact Phone:</strong> ${details.contactPhone}</p>
                        <p style="margin:2px 0;"><strong>Requested Delivery Date:</strong> ${details.formattedDeliveryDate}</p>
                    </div></div>
                </section>
                <section class="print-section" style="margin-bottom:10px;box-sizing:border-box;">
                    <h2 style="font-size:11pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:3px;margin-top:15px;margin-bottom:8px;text-align:left;color:#333;">REQUESTED PRODUCTS</h2>
                    <table class="print-product-table" style="width:100%;border-collapse:collapse;margin-top:8px;font-size:8.5pt;box-sizing:border-box;">
                        <thead style="font-size:8.5pt;"><tr style="page-break-inside:avoid;"><th class="product-name-col" style="border:1px solid #ccc;padding:4px 6px;text-align:center;background-color:#f0f0f0;font-weight:700;width:50%;box-sizing:border-box;">Product Name</th><th class="qty-col" style="border:1px solid #ccc;padding:4px 6px;text-align:center;background-color:#f0f0f0;font-weight:700;width:25%;box-sizing:border-box;">Quantity (LB)</th><th class="qty-col" style="border:1px solid #ccc;padding:4px 6px;text-align:center;background-color:#f0f0f0;font-weight:700;width:25%;box-sizing:border-box;">Quantity (PCS)</th></tr></thead>
                        <tbody style="font-size:8.5pt;">${productRowsHtml.replace(/<td/g,'<td style="border:1px solid #ccc;padding:4px 6px;text-align:left;vertical-align:top;box-sizing:border-box;word-break:break-word;"').replace(/class="product-name-col"/g,'style="width:50%;"').replace(/class="qty-col"/g,'style="width:25%;text-align:center;"')}</tbody>
                    </table>
                    <div class="print-totals" style="margin-top:10px;padding-top:10px;border-top:1px solid #666;font-size:9pt;box-sizing:border-box;">
                        <p style="margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline;"><span>Total Requested LB:</span><span style="margin-left:15px;">${details.totalLbText.replace(langSet.summaryUnitLB,"LB")}</span></p>
                        <p style="margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline;"><span>Total Requested PCS:</span><span style="margin-left:15px;">${details.totalPcsText.replace(langSet.summaryUnitPCS,"PCS")}</span></p>
                    </div>
                </section>
                <section class="print-section" style="margin-bottom:10px;box-sizing:border-box;">
                    <h2 style="font-size:11pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:3px;margin-top:15px;margin-bottom:8px;text-align:left;color:#333;">NOTES</h2>
                    <div class="print-notes" style="border:none;border-top:1px solid #ccc;border-bottom:1px solid #ccc;padding:8px 0;min-height:40px;margin-top:5px;font-size:8.5pt;white-space:pre-wrap;word-break:break-word;box-sizing:border-box;">${details.generalNotes.replace(/\n/g,'<br>')}</div>
                </section>
                <div style="height:1.5em;page-break-before:auto;"></div>
                <section class="print-signatures-footer-group" style="page-break-inside:avoid!important;margin-top:auto;box-sizing:border-box;">
                    <div class="print-signatures" style="margin-top:30px;display:flex;justify-content:space-between;font-size:8.5pt;align-items:flex-end;box-sizing:border-box;">
                        <div class="signature-block-print" style="width:45%;text-align:center;box-sizing:border-box;"><p style="margin:0;padding-top:15px;border-top:1px solid #666;">Delivered By (Signature)</p></div>
                        <div class="signature-block-print" style="width:45%;text-align:center;box-sizing:border-box;"><p style="margin:0;padding-top:15px;border-top:1px solid #666;">Received By (Signature)</p></div>
                    </div>
                    <footer class="print-footer" style="text-align:center;margin-top:20px;padding-top:8px;border-top:1px dashed #aaa;font-size:7.5pt;color:#555;box-sizing:border-box;">
                        <p>${companyNamePrint}</p>
                        <p>Address: ${COMPANY_ADDRESS_PRINT} | Phone: ${COMPANY_PHONE_PRINT}</p>
                    </footer>
                </section>
                </div>`;
            if(document.getElementById('printAreaContent') && !forPdfOrWord) {
                document.getElementById('printAreaContent').innerHTML = printHTML;
            }
            return printHTML;
        }

        async function generatePdfBlob() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF kütüphanesi yüklenemedi."); alert("PDF oluşturma kütüphanesi (jsPDF) yüklenemedi."); return null;
            }
            if (typeof html2canvas === 'undefined') {
                console.error("html2canvas kütüphanesi yüklenemedi."); alert("PDF oluşturma kütüphanesi (html2canvas) yüklenemedi."); return null;
            }

            const { jsPDF } = window.jspdf;
            const contentHtml = generatePrintContent(true);
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute'; tempDiv.style.left = '-9999px'; tempDiv.innerHTML = contentHtml;
            document.body.appendChild(tempDiv);
            const elementToCapture = tempDiv.querySelector('#captureForPdfOrWord');

            try {
                const canvas = await html2canvas(elementToCapture, { scale: 2, useCORS: true, logging: false });
                document.body.removeChild(tempDiv);
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                if (pdfHeight <= pdf.internal.pageSize.getHeight()) {
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                } else {
                    let numPages = Math.ceil(pdfHeight / pdf.internal.pageSize.getHeight());
                    let yPosition = 0;
                    for (let i = 0; i < numPages; i++) {
                        if (i > 0) pdf.addPage();
                        let sliceHeightOnCanvas = (pdf.internal.pageSize.getHeight() / pdfWidth) * imgProps.width;
                        sliceHeightOnCanvas = Math.min(sliceHeightOnCanvas, imgProps.height - yPosition);
                        const tempPageCanvas = document.createElement('canvas');
                        tempPageCanvas.width = imgProps.width; tempPageCanvas.height = sliceHeightOnCanvas;
                        const tempPageCtx = tempPageCanvas.getContext('2d');
                        const fullImage = new Image(); fullImage.src = imgData;
                        await new Promise(resolve => { if (fullImage.complete) resolve(); else fullImage.onload = resolve; });
                        tempPageCtx.drawImage(fullImage, 0, yPosition, imgProps.width, sliceHeightOnCanvas, 0, 0, imgProps.width, sliceHeightOnCanvas);
                        const pageImgData = tempPageCanvas.toDataURL('image/png');
                        const pagePdfHeight = (sliceHeightOnCanvas * pdfWidth) / imgProps.width;
                        pdf.addImage(pageImgData, 'PNG', 0, 0, pdfWidth, pagePdfHeight);
                        yPosition += sliceHeightOnCanvas;
                        if (yPosition >= imgProps.height) break;
                    }
                }
                return pdf.output('blob');
            } catch (error) {
                console.error("PDF oluşturma hatası:", error);
                if (tempDiv.parentElement) document.body.removeChild(tempDiv);
                return null;
            }
        }

        async function generateAndDownloadWord() {
            if (typeof htmlDocx === 'undefined' || typeof saveAs === 'undefined') {
                console.error("html-docx-js veya FileSaver kütüphanesi yüklenemedi."); alert("Word oluşturma kütüphaneleri yüklenemedi."); return;
            }
            const langSet = translations[currentLanguage] || translations.tr;
            shareModalMessage.textContent = "Word dosyası oluşturuluyor...";
            shareButtonsContainer.style.display = 'none';
            try {
                const contentHtml = generatePrintContent(true);
                const tempDiv = document.createElement('div'); tempDiv.innerHTML = contentHtml;
                const converted = htmlDocx.asBlob(tempDiv.querySelector('#captureForPdfOrWord').innerHTML, {
                    orientation: 'portrait',
                    margins: { top: 720, right: 720, bottom: 720, left: 720, header: 0, footer: 0, gutter: 0 }
                });
                saveAs(converted, `Siparis_${orderNoInput.value || 'form'}.docx`);
                shareModalMessage.textContent = langSet.shareModalMessageReady;
            } catch (error) {
                console.error("Word oluşturma hatası:", error);
                shareModalMessage.textContent = langSet.wordGenerationFailed;
            } finally {
                shareButtonsContainer.style.display = 'block';
            }
        }

        function getOrderSummaryAsText() {
            const details = getOrderDetails(true);
            const langSet = translations[currentLanguage] || translations.tr;
            let text = `${langSet.orderFormTitle}\n------------------------------------\n`;
            text += `${langSet.orderNoLabel} ${details.orderNo}\n`;
            text += `${langSet.orderDateLabel} ${details.displayOrderDate}\n`;
            text += `${langSet.authorizedPersonLabel} ${details.senderName}\n`;
            text += `${langSet.branchNameLabel} ${details.branchName}\n`;
            text += `${langSet.requestedDeliveryDateLabel} ${details.displayDeliveryDate}\n`;
            text += `${langSet.contactPhoneLabel} ${details.contactPhone}\n`;
            text += `------------------------------------\n${langSet.orderSummaryTitle.toUpperCase()}:\n`;
            if (details.summaryItems.length > 0) {
                details.summaryItems.forEach(item => { text += `- ${item.name}: ${item.quantity}\n`; });
            } else { text += `${langSet.emptySummaryText}\n`; }
            text += `\n------------------------------------\n${langSet.totalLbLabel} ${details.totalLbText}\n`;
            text += `${langSet.totalPcsLabel} ${details.totalPcsText}\n`;
            text += `\n${langSet.generalNotesTitle.toUpperCase()}:\n${details.generalNotes}\n`;
            text += `------------------------------------\n`;
            return text;
        }

        function initializeMainForm(){
            if (mainFormInitialized) return;
            assignMainFormDOMElements();
            mainFormInitialized = true;

            populateBranchSelect();
            loadFormSettings();
            setInitialDates();
            setFooterInfo();
            setDeveloperSignature();
            renderProducts();
            updateOrderSummary();

            let orderCounter = 0;
            try { orderCounter = parseInt(localStorage.getItem(LS_ORDER_COUNTER)) || 0; } catch(e) { console.warn("Sipariş sayacı okuma hatası:", e); }
            orderCounter++;
            try { localStorage.setItem(LS_ORDER_COUNTER, orderCounter); } catch(e) { console.warn("Sipariş sayacı kaydetme hatası:", e); }

            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            if(orderNoInput) orderNoInput.value = `S-${year}${month}${day}-${orderCounter.toString().padStart(3, '0')}-${(Math.floor(Math.random() * 900) + 100)}`;

            if(orderSenderNameInput) orderSenderNameInput.addEventListener('input', () => saveFormSetting(LS_SENDER_NAME, orderSenderNameInput.value));
            if(contactPhoneInput) contactPhoneInput.addEventListener('input', () => saveFormSetting(LS_CONTACT_PHONE, contactPhoneInput.value));
            if(branchSelect) branchSelect.addEventListener('change', () => saveFormSetting(LS_BRANCH_SELECT_VALUE, branchSelect.value));
            if(manualBranchInput) manualBranchInput.addEventListener('input', () => saveFormSetting(LS_MANUAL_BRANCH_VALUE, manualBranchInput.value));
            if(manualBranchCheckbox) manualBranchCheckbox.addEventListener('change', () => { updateBranchInputState(); saveFormSetting(LS_MANUAL_BRANCH_ENABLED, manualBranchCheckbox.checked); });
            if(orderDateInput) orderDateInput.addEventListener('change', () => saveFormSetting(LS_ORDER_DATE, orderDateInput.value));
            if(deliveryDateInput) deliveryDateInput.addEventListener('change', () => saveFormSetting(LS_DELIVERY_DATE, deliveryDateInput.value));

            if (mainFormLangTrBtn) mainFormLangTrBtn.addEventListener('click', () => setLanguage('tr'));
            if (mainFormLangEnBtn) mainFormLangEnBtn.addEventListener('click', () => setLanguage('en'));

            if (printButton) printButton.onclick = function() { if(!mainFormInitialized || !validateOrderForm()) return; generatePrintContent(false); window.print(); };

            if (sendEmailBtn) sendEmailBtn.addEventListener('click', function() {
                if(!mainFormInitialized || !validateOrderForm()) return;
                const details = getOrderDetails(true);
                const emailBody = getOrderSummaryAsText();
                const subject = `New Order Request - No: ${details.orderNo} - Branch: ${details.branchName} - By: ${details.senderName}`;
                window.location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            });

            if (shareButton) shareButton.addEventListener('click', async function() {
                if(!mainFormInitialized || !validateOrderForm()) return;
                const langSet = translations[currentLanguage] || translations.tr;
                shareOptionsModal.style.display = 'flex';
                shareModalMessage.textContent = langSet.shareModalMessage;
                shareButtonsContainer.style.display = 'none';
                const pdfBlob = await generatePdfBlob();
                let pdfFileForSharing = null;
                if (pdfBlob) {
                    pdfFileForSharing = new File([pdfBlob], `Siparis_${orderNoInput.value || 'form'}.pdf`, { type: 'application/pdf' });
                    downloadPdfButton.onclick = () => { const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.href = url; a.download = `Siparis_${orderNoInput.value || 'form'}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
                    shareModalMessage.textContent = langSet.shareModalMessageReady;
                } else { shareModalMessage.textContent = langSet.pdfGenerationFailed; }
                shareButtonsContainer.style.display = 'block';
                if (navigator.share && pdfFileForSharing) {
                    try {
                        const details = getOrderDetails();
                        await navigator.share({ title: `Sipariş Formu - ${details.orderNo}`, text: `Sipariş Formu: ${details.orderNo} - ${details.branchName}`, files: [pdfFileForSharing] });
                        shareOptionsModal.style.display = 'none';
                    } catch (err) {
                        console.error('Share failed:', err.message);
                        if (err.name !== 'AbortError') { shareModalMessage.textContent += ` (${langSet.webShareNotSupported})`; }
                    }
                } else if (pdfBlob) { shareModalMessage.textContent = langSet.shareModalMessageReady + (navigator.share ? '' : ` (${langSet.webShareNotSupported})`); }
            });

            if (closeShareModalButton) closeShareModalButton.addEventListener('click', () => { shareOptionsModal.style.display = 'none'; });
            if (downloadWordButton) downloadWordButton.addEventListener('click', generateAndDownloadWord);
            window.addEventListener('click', (event) => { if (event.target === shareOptionsModal) shareOptionsModal.style.display = "none"; });
        }

        function onPageLoad() {
            console.log('DOM fully loaded and parsed.');
            assignLoginDOMElements();
            loadLanguage();
            loadRememberMe();

            if (!checkAuth()) {
                if (loginButton) loginButton.addEventListener('click', handleLogin);
                if (passwordInput) passwordInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); handleLogin(); }});
                if (usernameInput) usernameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); if(passwordInput) passwordInput.focus(); }});
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', onPageLoad);
        } else {
            onPageLoad();
        }

        // PWA Service Worker Kaydı
        console.log('PWA Script: Attempting to register Service Worker...');
        if ('serviceWorker' in navigator) {
            console.log('PWA Script: Service Worker API is available in navigator.');
            window.addEventListener('load', () => {
                console.log('PWA Script: Window (including all resources) fully loaded. Registering Service Worker from ./sw.js');
                navigator.serviceWorker.register('./sw.js', { scope: './' }) // GitHub Pages'da /key/ altındaysa scope: './' genellikle doğrudur.
                    .then((registration) => {
                        console.log('PWA Script: Service Worker registered successfully! Scope is: ', registration.scope);
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            console.log('PWA Script: New content is available; please refresh.');
                                        } else {
                                            console.log('PWA Script: Content is cached for offline use (basic).');
                                        }
                                    }
                                };
                            }
                        };
                    })
                    .catch((registrationError) => {
                        console.error('PWA Script: Service Worker registration FAILED: ', registrationError);
                    });
            });
        } else {
            console.warn('PWA Script: Service Worker is NOT supported by this browser.');
        }
    })();
    </script>
</body>
</html>
