<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Selda Mediterranean - Product Order Form</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#28a745">
    <link rel="apple-touch-icon" href="./apple-touch-icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Selda Mediterranean ürün sipariş formu uygulaması.">

    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #007AFF;
            --banner-bg-color: #F2F2F7;
            --banner-text-color: #1D1D1F;
            --secondary-color: #8A8A8E;
            --light-gray: #F2F2F7;
            --medium-gray: #E5E5EA;
            --dark-gray: #1D1D1F;
            --white: #fff;
            --border-color: #D1D1D6;
            --border-radius-sm: 5px;
            --border-radius-md: 7px;
            --border-radius-lg: 10px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --input-bg-disabled: #f5f5f5;
            --summary-total-bg: #f9f9f9;
            --macos-control-bg: #fff;
            --macos-control-border: #C6C6C8;
            --macos-control-hover-bg: #F5F5F5;
            --macos-focus-ring: rgba(40, 167, 69, 0.25);
            --original-green: #28a745;
            --original-green-darker: #1e7e34;
            --macos-section-header-bg-prominent: #E9E9EB;
            --macos-section-header-text: #333;
            --macos-section-header-border: #DCDCE0;
        }
        body {font-family: var(--font-family); margin: 0; padding: 0; background-color: var(--light-gray); color: var(--dark-gray); display: flex; flex-direction: column; align-items: center; min-height: 100vh;}
        #loginScreen {position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 1; visibility: visible; transition: opacity 0.5s ease, visibility 0.5s ease; overflow-y: auto;}
        #loginScreen.hidden {opacity: 0; visibility: hidden; pointer-events: none;}
        .login-container {background-color: var(--white); padding: 30px 40px; border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; width: 100%; max-width: 360px; box-sizing: border-box; margin: 20px;}
        #loginScreen h2 {color: var(--dark-gray); margin-top: 0; margin-bottom: 25px; font-size: 1.7em; font-weight: 600;}
        #loginScreen input[type="text"],
        #loginScreen input[type="password"] {
            width: calc(100% - 22px); padding: 12px 10px; margin-bottom: 15px;
            border: 1px solid var(--border-color); border-radius: var(--border-radius-sm);
            font-size: 1em; box-sizing: border-box; background-color: var(--macos-control-bg);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #loginScreen input[type="text"]:focus,
        #loginScreen input[type="password"]:focus {
            border-color: var(--original-green); outline: none;
            box-shadow: 0 0 0 3px var(--macos-focus-ring);
        }
        .remember-me-container { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 15px; font-size: 0.9em; }
        .remember-me-container input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); accent-color: var(--original-green);}
        .remember-me-container label { cursor: pointer; color: #555; }
        #loginScreen button {
            background-color: var(--original-green);
            color: var(--white); border: none;
            padding: 12px 20px; text-align: center; text-decoration: none; display: inline-block;
            font-size: 1.05em; font-weight: bold; margin-top: 10px; border-radius: var(--border-radius-sm);
            cursor: pointer; transition: background-color 0.3s ease; width: 100%;
        }
        #loginScreen button:hover {background-color: var(--original-green-darker);}
        #loginScreen button:active {background-color: #1a6c2c;}
        .login-error-message {color: #dc3545; font-size: 0.9em; margin-top: 10px; min-height: 1.2em;}

        .page-wrapper {display: flex; flex-direction: column; width: 100%; max-width: 1800px; padding: 20px; box-sizing: border-box; flex-grow: 1;}
        @media (min-width: 992px) {.page-wrapper {flex-direction: row; align-items: flex-start; justify-content: center;}}
        .main-content {flex-grow: 1; width: 100%;}
        .container {background-color: var(--white); padding: 25px 35px; border-radius: var(--border-radius-lg); box-shadow: 0 6px 18px rgba(0,0,0,0.08); width: 100%; box-sizing: border-box;}
        .page-header {text-align: center; margin-bottom: 20px; position: relative;}
        .page-header img {
            max-width: 150px; height: auto;
            filter: drop-shadow(0px 3px 5px rgba(0,0,0,0.15));
        }
        .language-selector {position: absolute; top: 10px; right: 10px; display: flex; gap: 6px;}
        .language-selector button {
            background-color: var(--macos-control-bg); color: var(--dark-gray);
            border: 1px solid var(--macos-control-border); padding: 6px 10px;
            border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.8em;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .language-selector button:hover {background-color: var(--macos-control-hover-bg);}
        .language-selector button.active {background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color);}

        .main-title-button {
            background-color: var(--banner-bg-color); color: var(--banner-text-color);
            padding: 15px; border-radius: var(--border-radius-md); text-align: center;
            font-size: 1.5em; font-weight: 600; margin-bottom: 25px;
            border: 1px solid var(--macos-section-header-border);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .section-title {
            background-color: var(--macos-section-header-bg-prominent);
            color: var(--dark-gray);
            padding: 8px 12px;
            border-radius: var(--border-radius-md);
            margin-top: 15px;
            margin-bottom: 0; font-size: 1em;
            font-weight: 500;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            user-select: none; border: 1px solid var(--macos-section-header-border);
            border-bottom-left-radius: 0; border-bottom-right-radius: 0;
            transition: background-color 0.2s ease;
        }
        .section-title:hover { background-color: #DADAE0; }
        .section-title:focus {outline: 2px solid var(--primary-color); outline-offset: 1px;}
        .section-title.has-selection {background-color: #D0E8FF; border-color: #B3D7FF;}
        .category-title-text {flex-grow: 1;}
        .category-search-container {margin-left: 8px; display: flex; align-items: center;}
        .category-search-box {
            padding: 3px 6px;
            border: 1px solid var(--macos-control-border); border-radius: var(--border-radius-sm);
            font-size: 0.65em;
            width: 70px; background-color: var(--white); color: var(--dark-gray);
            transition: width 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .category-search-box:focus {width: 110px; border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.3);}
        .section-title .toggle-icon::before {
            content: '›';
            font-size: 1.2em;
            line-height: 1;
            font-weight: bold;
            color: var(--secondary-color);
            margin-left: 6px;
            transition: transform 0.25s ease-out;
            display: inline-block;
        }
        .section-title:not(.collapsed) .toggle-icon::before {
            transform: rotate(90deg);
        }
        .section-title.collapsed + .product-table-wrapper {max-height: 0; overflow-y: hidden; border-top: none;}
        .section-title:not(.collapsed) + .product-table-wrapper {overflow-y: auto;}

        .general-notes-title-styling {border-radius: var(--border-radius-md); border-bottom-left-radius: var(--border-radius-md) !important; border-bottom-right-radius: var(--border-radius-md) !important; cursor: default !important;}
        .general-notes-title-styling .toggle-icon,
        .general-notes-title-styling .category-search-container {display: none;}

        .product-table-wrapper {
            max-height: 350px;
            overflow-y: auto;
            transition: max-height 0.4s ease-in-out, border 0.3s ease;
            border: 1px solid var(--macos-section-header-border); border-top: none;
            border-bottom-left-radius: var(--border-radius-md); border-bottom-right-radius: var(--border-radius-md);
            margin-bottom: 20px;
        }
        table.info-table, table.product-table {width: 100%; border-collapse: collapse;}
        .info-table th, .info-table td, .product-table th, .product-table td {border: 1px solid var(--border-color); padding: 8px 10px; text-align: left; vertical-align: top; word-break: break-word; font-size: 0.9em;}

        .product-table th {
            text-align: center; background-color: #f9f9f9; font-weight: 500;
            position: sticky; top: 0; z-index: 2;
            border-bottom: 1.5px solid var(--macos-section-header-border);
            font-size: 0.85em;
        }
        .product-table th.dessert-pcs-header {
            width: auto !important;
            text-align: center;
        }
        .product-table th.kunefe-header {
            width: 50% !important;
        }


        .info-table th {background-color: var(--medium-gray); font-weight: 500; font-size: 0.85em; width: 220px; white-space: nowrap;}
        .branch-input-container {display: flex; align-items: center; gap: 10px; flex-wrap: nowrap;}
        .branch-input-container select {flex-grow: 1; min-width: 150px;}
        .branch-input-container input[type="checkbox"] {margin-left: auto; margin-right: 5px; transform: scale(1.2); flex-shrink: 0; accent-color: var(--primary-color);}
        #manualBranchInput {width: calc(100% - 20px); margin-top: 8px; box-sizing: border-box;}
        .product-row.selected-row {background-color: #E6F2FF !important;}
        .product-row.selected-row td:first-child {color: var(--primary-color); font-weight: 500;}
        .product-row.hidden-by-search {display: none !important;}

        input[type="text"], input[type="date"], input[type="time"], input[type="email"], select, textarea {
            width: calc(100% - 20px); padding: 9px 10px;
            border: 1px solid var(--macos-control-border); border-radius: var(--border-radius-sm);
            box-sizing: border-box; font-size: 0.9em; background-color: var(--macos-control-bg);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="email"]:focus, select:focus, textarea:focus {
            border-color: var(--primary-color); outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
        }
        textarea {min-height: 75px;}
        input[type="number"].manual-qty-input {
            width: 60px; padding: 6px; text-align: center; margin-left: 5px;
            font-size: 0.85em; border: 1px solid var(--macos-control-border);
            border-radius: var(--border-radius-sm); background-color: var(--macos-control-bg);
        }
        .quantity-options {display: flex; flex-direction: column; gap: 5px;}
        .quantity-options label {
            margin-right: 8px; font-size: 0.9em; display: inline-flex;
            align-items: center; cursor: pointer; padding: 4px 0;
        }
        .quantity-options label:has(.manual-qty-input) {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
        }
        .quantity-options label span.qty-label-text {
            margin-left: 4px;
            white-space: nowrap;
            flex-shrink: 0;
            margin-right: 4px;
        }
        .quantity-options label .manual-qty-input {
            min-width: 50px;
        }
        .kunefe-options-container {
            display: flex;
            gap: 0;
            align-items: flex-start;
            width: 100%;
        }
        .kunefe-options-group {
            flex: 1;
            padding: 5px;
        }
        .kunefe-options-group:first-child {
            border-right: 1px solid var(--border-color);
            padding-right: 10px;
        }
         .kunefe-options-group:last-child {
            padding-left: 10px;
        }

        .kunefe-options-group .size-label {
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
            font-size: 0.85em;
            color: var(--dark-gray);
            text-align: center;
        }
        .specific-unit-label {
            font-weight: 500;
            margin-bottom: 5px;
            display: block;
            font-size: 0.85em;
            color: var(--dark-gray);
            text-align: center;
        }


        .quantity-options input[type="checkbox"] {margin-right: 6px; transform: scale(1.2); cursor: pointer; accent-color: var(--primary-color);}
        input[readonly], input[type="text"]:disabled, select:disabled {background-color: var(--input-bg-disabled); cursor: not-allowed; color: #777;}
        .buttons-area {margin-top: 25px; text-align: right; padding-top: 18px; border-top: 1px solid var(--medium-gray); display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-end;}
        .buttons-area button {
            color: var(--white); border: none; padding: 10px 18px;
            text-align: center; text-decoration: none; display: inline-block;
            font-size: 0.9em; font-weight: 500; border-radius: var(--border-radius-md);
            cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .buttons-area button:active { transform: translateY(1px); }
        .buttons-area button.print-btn {background-color: var(--primary-color);}
        .buttons-area button.print-btn:hover {background-color: #0068d6;}
        .buttons-area button#sendEmailBtn {background-color: var(--secondary-color);}
        .buttons-area button#sendEmailBtn:hover {background-color: #7a7a7e;}
        .buttons-area button.share-btn {background-color: #34C759;}
        .buttons-area button.share-btn:hover {background-color: #2baa4f;}

        .page-footer {text-align: center; margin-top: auto; padding: 18px 0; border-top: 1px solid var(--medium-gray); font-size: 0.85em; color: #555; width: 100%; background-color: var(--light-gray);}
        .developer-signature {text-align: center; font-size: 0.75em; color: var(--secondary-color); padding: 8px 0; width: 100%; background-color: var(--light-gray);}

        .order-summary-panel {width: 100%; max-width: 300px; min-width: 280px; background-color: #FDFDFD; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); align-self: flex-start; display: flex; flex-direction: column; transition: height 0.3s ease-out; margin-top: 20px;}
        @media (min-width: 992px) {.order-summary-panel {position: sticky; top: 20px; width: 320px; margin-top: 0; margin-left: 20px;}}
        .order-summary-panel h3 {margin-top: 0; font-size: 1.1em; font-weight: 500; color: var(--dark-gray); border-bottom: 1px solid var(--medium-gray); padding-bottom: 8px; margin-bottom: 8px; flex-shrink: 0;}
        .order-summary-list-container {overflow-y: auto; max-height: 380px; margin-bottom: 10px; flex-grow: 1;}
        .order-summary-list {list-style: none; padding: 0; margin: 0;}
        .order-summary-list li {padding: 7px 0; font-size: 0.85em; border-bottom: 1px dashed #EAEAEA; display: flex; justify-content: space-between; align-items: center;}
        .order-summary-list li:last-child {border-bottom: none;}
        .summary-product-name {flex-grow: 1; margin-right: 8px; color: #333;}
        .summary-product-qty {font-weight: 500; white-space: nowrap; text-align: right; color: var(--primary-color);}
        .empty-summary {text-align: center; color: var(--secondary-color); font-style: italic; padding: 18px 0;}
        .summary-totals {margin-top: auto; padding: 9px; border-top: 1px solid var(--border-color); font-size: 0.9em; flex-shrink: 0; background-color: var(--summary-total-bg); border-radius: var(--border-radius-sm);}
        .summary-totals div {display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: 500;}
        .summary-totals div span:first-child {color: #444;}
        .summary-totals span:last-child {color: var(--dark-gray);}

        @media (max-width: 991px) {
            .container {padding: 20px 15px;} .main-title-button {font-size: 1.3em; padding: 12px;}
            .section-title {font-size: 0.95em; padding: 7px 10px;}
            .category-search-box {font-size: 0.6em; width: 65px;} .category-search-box:focus {width: 100px;}
            .info-table th, .info-table td, .product-table th, .product-table td {padding: 6px 8px; font-size: 0.85em;}
            .info-table th {width: auto; min-width: 110px; font-size: 0.8em; white-space: normal;} .info-table td {min-width: 140px;}
            .branch-input-container {flex-wrap: wrap;}
            input[type="text"], input[type="date"], input[type="time"], input[type="email"], select, textarea {font-size: 0.9em; padding: 8px 9px; width: 100%;}
            #manualBranchInput {width: 100%;}
            input[type="number"].manual-qty-input {width: 55px; font-size: 0.8em;}
            .quantity-options label {font-size: 0.85em;}
            .quantity-options label:has(.manual-qty-input) { flex-direction: row; align-items: center; }
            .quantity-options label:has(.manual-qty-input) span.qty-label-text { margin-bottom: 0; margin-right: 4px;}

            .buttons-area {text-align: center; justify-content: center;}
            .buttons-area button {padding: 9px 15px; font-size: 0.85em; margin: 5px 5px 10px; width: calc(50% - 12px); min-width: 110px;}
            @media (max-width: 991px) and (min-width: 481px) {.buttons-area button {width: calc(33.33% - 10px);}}
            @media (max-width: 480px) {.buttons-area button {width: 100%; margin-left: 0; margin-right: 0;}}
            .order-summary-panel {max-width: 100%; min-width: unset; margin-left: 0; margin-top: 25px; border-radius: var(--border-radius-lg);}
            .order-summary-list-container {max-height: 300px;} .order-summary-panel h3 {font-size: 1em;}
            .order-summary-list li {font-size: 0.8em;} .summary-totals {font-size: 0.85em;}
             .kunefe-options-container { flex-direction: column; gap: 5px;}
             .kunefe-options-group:first-child { border-right: none; padding-right: 5px; }
             .kunefe-options-group:last-child { padding-left: 5px; }
        }
        @media (max-width: 767px) {
            .page-header img {max-width: 120px;} .language-selector {top: 5px; right: 5px; gap: 4px;}
            .language-selector button {padding: 5px 8px; font-size: 0.75em;} .main-title-button {font-size: 1.1em;}
            .info-table, .info-table tbody, .info-table tr, .info-table td, .info-table th {display: block; width: 100% !important; box-sizing: border-box;}
            .info-table tr {margin-bottom: 10px;} .info-table th {text-align: left; border-bottom: none; background-color: var(--medium-gray);}
            .info-table td {border-top: none;}
            .product-table th:nth-child(2), .product-table th:nth-child(3), .product-table th.dessert-pcs-header {width: 100px !important; font-size: 0.8em;}
            .quantity-options {align-items: flex-start;}
        }
        @media (max-width: 480px) {
            .container {padding: 15px 10px;} .page-header img {max-width: 110px;}
            .login-container {padding: 25px 20px; max-width: calc(100% - 30px);}
            .category-search-box {width: 60px;} .category-search-box:focus {width: 90px;}
            .quantity-options label:has(.manual-qty-input) {
                flex-direction: column;
                align-items: flex-start;
            }
            .quantity-options label:has(.manual-qty-input) span.qty-label-text {
                margin-bottom: 3px;
                margin-right: 0;
            }
            .quantity-options label:has(.manual-qty-input) .manual-qty-input {
                 width: 100%;
                 margin-left: 0;
            }
        }
        
        /* --- PRINT STYLES --- */
        @media print {
            body {margin:0!important;padding:0!important;background-color:var(--white)!important;font-family:Arial,sans-serif;font-size:8pt!important;color:#000!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}
            #loginScreen,.page-wrapper,.order-summary-panel,.page-footer,.buttons-area,.main-title-button,.language-selector,.developer-signature,#shareOptionsModal{display:none!important}
            
            #printAreaContainer{display:block!important;margin:0 auto!important;padding:0!important;width:100%}
            #printAreaContent{ /* This is the direct parent for browser print content */
                margin:0;padding:0; 
                display: flex; flex-direction: column; /* For footer push in browser print */
                min-height: 97vh; /* Adjusted slightly for better fit */
                box-sizing: border-box;
            }
            #printAreaContent *, #printAreaContent *::before, #printAreaContent *::after{box-sizing:border-box}
            
            .print-header{text-align:center;margin-bottom:10px;border-bottom:1.5px solid #000;padding-bottom:6px}
            .print-logo{max-width:80px !important; height:auto !important;margin-bottom:6px;display:block;margin-left:auto;margin-right:auto;}
            /* H1 specifically for #printAreaContent, not inside #captureForPdfOrWord */
            #printAreaContent > h1, #printAreaContent > .print-header > h1 {font-size:13pt;font-weight:700;margin-top:4px;margin-bottom:8px;text-align:center;color:#333}
            .print-order-info{display:flex;justify-content:space-between;align-items:center;width:100%;margin-top:4px;font-size:8.5pt}
            .print-order-info span{margin:1px 0}
            
            .print-section{margin-bottom:8px}
            /* H2 specifically for #printAreaContent */
            #printAreaContent > .print-section > h2, #printAreaContent > .print-notes-signatures-footer-group > .print-section > h2 {font-size:10pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:2px;margin-top:12px;margin-bottom:6px;text-align:left;color:#333}
            
            .print-info-compact .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:2px 12px;font-size:8.5pt}
            .print-info-compact .info-grid p{margin:1.5px 0}
            
            .print-product-table{width:100%;border-collapse:collapse;margin-top:6px;font-size:8pt}
            .print-product-table th,.print-product-table td{border:1px solid #ccc;padding:3px 5px;text-align:left;word-break:break-word;overflow-wrap:break-word}
            .print-product-table th{background-color:#f0f0f0!important;font-weight:700;text-align:center} /* Added !important for bg */
            .print-product-table td{vertical-align:top}
            .print-product-table .product-name-col{width:auto;}
            .print-product-table .unit-col{width:auto;text-align:center;}
            
            .print-totals{margin-top:8px;padding-top:8px;border-top:1px solid #666;font-size:8.5pt}
            .print-totals p{margin:3px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline}
            .print-totals p span:first-child{margin-right:12px}
            
            .print-notes-signatures-footer-group {
                page-break-inside: avoid !important;
                margin-top: auto; /* This pushes footer down for browser printing due to #printAreaContent flex */
                padding-top: 10px;
                flex-shrink: 0; 
            }
            .print-notes{border:none;border-top:1px solid #ccc;border-bottom:1px solid #ccc;padding:6px 0;min-height:30px;margin-top:4px;font-size:8pt;white-space:pre-wrap;word-break:break-word}
            .print-signatures{margin-top:25px;display:flex;justify-content:space-between;font-size:8pt;align-items:flex-end}
            .signature-block-print{width:45%;text-align:center}
            .signature-block-print p{margin:0;padding-top:12px;border-top:1px solid #666}
            
            .print-footer{text-align:center;margin-top:15px;padding-top:6px;border-top:1px dashed #aaa;font-size:7pt;color:#555}
            
            .print-section,.print-product-table tbody tr, .print-notes-signatures-footer-group{page-break-inside:avoid!important}
            @page{size:A4 portrait;margin:10mm}
        }
        /* --- End PRINT STYLES --- */

        .modal {display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.55);justify-content:center;align-items:center}
        .modal-content {
            background-color:var(--white); margin:auto; padding:30px;
            border:none;
            width:90%;max-width:480px; border-radius:var(--border-radius-lg);
            box-shadow:0 10px 30px rgba(0,0,0,.2);
            text-align:center;
        }
        .modal-content h4 {margin-top:0;color:var(--dark-gray); font-size: 1.3em; font-weight: 500; margin-bottom: 15px;}
        .modal-content button {
            background-color:var(--primary-color);color:#fff;padding:12px 18px;
            margin:10px 6px;border:none;border-radius:var(--border-radius-md);
            cursor:pointer;font-size:.95em; font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .modal-content button:hover {background-color: #0068d6;}
        .modal-content button.secondary {background-color:var(--secondary-color); color: var(--white);}
        .modal-content button.secondary:hover {background-color: #7a7a7e;}
        .close-modal-btn {background-color:#E5E5EA;color:var(--dark-gray);}
        .close-modal-btn:hover {background-color: #DCDCE0;}
        .modal-message {font-size:.95em;color:#444;margin-bottom:20px;min-height:1.2em;}
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <h2 id="loginTitle" data-translate="loginTitle">Giriş Yap</h2>
            <input type="text" id="username" data-translate-placeholder="usernamePlaceholder" placeholder="Kullanıcı Adı" autocomplete="username">
            <input type="password" id="password" data-translate-placeholder="passwordPlaceholder" placeholder="Şifre" autocomplete="current-password">
            <div class="remember-me-container">
                <input type="checkbox" id="rememberMeCheckbox">
                <label for="rememberMeCheckbox" id="rememberMeLabel" data-translate="rememberMeLabel">Beni Hatırla</label>
            </div>
            <button id="loginButton" data-translate="loginButtonText">GİRİŞ</button>
            <p id="loginError" class="login-error-message" style="display:none;"></p>
        </div>
    </div>

    <div class="page-wrapper" style="display: none;">
        <main class="main-content">
            <div class="container">
                <header class="page-header">
                    <img src="./logo.png" alt="Selda Mediterranean Logo" onerror="this.onerror=null; this.src='https://via.placeholder.com/160x60?text=Selda+Logo'; this.alt='Placeholder Logo';">
                    <div class="language-selector">
                        <button id="langTrBtn">TR</button>
                        <button id="langEnBtn">EN</button>
                    </div>
                </header>
                <div class="main-title-button" data-translate="orderFormTitle">ÜRÜN SİPARİŞ FORMU</div>
                <form id="orderForm">
                    <table class="info-table">
                        <tr>
                            <th data-translate="orderNoLabel">Sipariş No:</th>
                            <td><input type="text" id="orderNo" readonly></td>
                            <th data-translate="orderDateLabel">Sipariş Tarihi:</th>
                            <td><input type="date" id="orderDate"></td>
                        </tr>
                        <tr>
                            <th data-translate="authorizedPersonLabel">Sipariş Veren Yetkili:</th>
                            <td><input type="text" id="orderSenderName" data-translate-placeholder="authPersonPlaceholder" placeholder="Adınız Soyadınız" required></td>
                            <th data-translate="branchNameLabel">Şube Adı:</th>
                            <td>
                                <div class="branch-input-container">
                                    <select id="branchSelect"></select>
                                    <input type="checkbox" id="manualBranchCheckbox" data-translate-title="manualBranchCheckboxTitle" title="Elle Şube Adı Gir">
                                </div>
                                <input type="text" id="manualBranchInput" data-translate-placeholder="manualBranchInputPlaceholder" placeholder="Şube adını buraya yazın..." style="display: none;">
                            </td>
                        </tr>
                        <tr>
                            <th data-translate="requestedDeliveryDateLabel">Talep Edilen Teslim Tarihi:</th>
                            <td><input type="date" id="deliveryDate"></td>
                            <th data-translate="contactPhoneLabel">İletişim Telefonu (Şube):</th>
                            <td><input type="text" id="contactPhone" data-translate-placeholder="contactPhonePlaceholder" placeholder="Şube telefon numarası"></td>
                        </tr>
                    </table>
                    <div id="productSectionsContainer"></div>
                    <div class="section-title general-notes-title-styling" style="margin-top:10px;" data-translate="generalNotesTitle">GENEL NOTLAR</div>
                    <textarea id="generalNotes" data-translate-placeholder="generalNotesPlaceholder" placeholder="Siparişle ilgili genel notlarınız..."></textarea>
                    <div class="buttons-area">
                        <button type="button" class="print-btn" data-translate="printButton">YAZDIR</button>
                        <button type="button" id="sendEmailBtn" data-translate="sendOrderButton">POSTA GÖNDER</button>
                        <button type="button" id="shareButton" class="share-btn" data-translate="shareButtonText">PAYLAŞ</button>
                    </div>
                </form>
            </div>
        </main>
        <aside class="order-summary-panel" id="orderSummaryPanel">
            <h3 data-translate="orderSummaryTitle">Sipariş Özeti</h3>
            <div class="order-summary-list-container" id="summaryListContainer">
                <ul class="order-summary-list" id="summaryList"></ul>
                <p class="empty-summary" id="emptySummaryText" data-translate="emptySummaryText">Henüz ürün seçilmedi.</p>
            </div>
            <div class="summary-totals" id="summaryTotals">
                <div><span data-translate="totalLbLabel">Toplam LB:</span> <span id="totalLb">0 LB</span></div>
                <div id="totalQuartRow" style="display:none;"><span data-translate="totalQuartLabel">Toplam Quart:</span> <span id="totalQuart">0 Quart</span></div>
                <div><span data-translate="totalPcsLabel">Toplam Adet:</span> <span id="totalAdet">0 Adet</span></div>
            </div>
        </aside>
    </div>
    <footer class="page-footer">
        <p><strong id="footerCompanyName" data-translate="footerCompanyName">Selda Mediterranean - Merkezi Mutfak</strong></p>
        <p>Adres: <span id="footerCompanyAddress"></span> | Telefon: <span id="footerCompanyPhone"></span></p>
    </footer>
    <div class="developer-signature"></div>
    
    <!-- Container for browser print content -->
    <div id="printAreaContainer" style="display: none;">
        <div id="printAreaContent"></div>
    </div>

    <div id="shareOptionsModal" class="modal">
        <div class="modal-content">
            <h4 data-translate="shareModalTitle">Sipariş Formunu Paylaş</h4>
            <p id="shareModalMessage" class="modal-message" data-translate="shareModalMessage">PDF oluşturuluyor, lütfen bekleyin...</p>
            <div id="shareButtonsContainer" style="display:none;">
                <button id="downloadPdfButton" data-translate="downloadPdfButton">PDF İndir</button>
                <button id="downloadWordButton" data-translate="downloadWordButton">Word Olarak İndir</button>
            </div>
            <button id="closeShareModalButton" class="close-modal-btn" data-translate="closeButton">Kapat</button>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        let mainFormInitialized = false;

        const CORRECT_USERNAME = "Kitchen";
        const CORRECT_PASSWORD = "S8246";
        const AUTH_KEY_SESSION = 'seldaOrderForm_authenticated_v23_print_final';
        const LS_REMEMBER_USER = 'seldaOrderForm_rememberUser_v2';
        const LS_REMEMBERED_USERNAME = 'seldaOrderForm_rememberedUsername_v2';
        const LS_REMEMBERED_PASSWORD = 'seldaOrderForm_rememberedPassword_v2';

        let loginScreen, usernameInput, passwordInput, rememberMeCheckbox, loginButton, loginError;
        let pageWrapper, orderSenderNameInput, contactPhoneInput, branchSelect, manualBranchCheckbox, manualBranchInput,
            orderDateInput, deliveryDateInput, orderNoInput, generalNotesInput,
            mainFormLangTrBtn, mainFormLangEnBtn,
            printButton, sendEmailBtn, shareButton,
            shareOptionsModal, closeShareModalButton, downloadPdfButton, downloadWordButton,
            shareModalMessage, shareButtonsContainer;

        const COMPANY_ADDRESS_PRINT = "14902 Preston Rd Ste 512A, TX 75254";
        const COMPANY_PHONE_PRINT = "214-377-7716";
        const EMAIL_RECIPIENT = "kadireymurus@gmail.com";

        const translations = {
            "tr": {
                "pageTitle": "Selda Mediterranean - Ürün Sipariş Formu", "orderFormTitle": "ÜRÜN SİPARİŞ FORMU",
                "orderNoLabel": "Sipariş No:", "orderDateLabel": "Sipariş Tarihi:",
                "authorizedPersonLabel": "Sipariş Veren Yetkili:", "authPersonPlaceholder": "Adınız Soyadınız",
                "branchNameLabel": "Şube Adı:", "manualBranchCheckboxTitle": "Elle Şube Adı Gir",
                "manualBranchInputPlaceholder": "Şube adını buraya yazın...",
                "requestedDeliveryDateLabel": "Talep Edilen Teslim Tarihi:",
                "contactPhoneLabel": "İletişim Telefonu (Şube):", "contactPhonePlaceholder": "Şube telefon numarası",
                "productNameHeader": "Ürün Adı", "lbHeader": "Pound (LB)", "pcsUnitHeader": "Adet",
                "quartHeader": "Quart", "kunefeSmallHeader": "Küçük", "kunefeLargeHeader": "Büyük",
                "otherLabel": "Diğer:", "generalNotesTitle": "GENEL NOTLAR", "generalNotesTitleHeader": "NOTLAR", // Added for print header
                "generalNotesPlaceholder": "Siparişle ilgili genel notlarınız...",
                "printButton": "YAZDIR", "sendOrderButton": "POSTA GÖNDER", "shareButtonText": "PAYLAŞ",
                "orderSummaryTitle": "Sipariş Özeti", "emptySummaryText": "Henüz ürün seçilmedi.",
                "totalLbLabel": "Toplam LB:", "totalPcsLabel": "Toplam Adet:", "totalQuartLabel": "Toplam Quart:",
                "footerCompanyName": "Selda Mediterranean - Merkezi Mutfak",
                "alert_authPersonMissing": "Lütfen 'Sipariş Veren Yetkili' adını giriniz.",
                "alert_orderDateInvalid": "Lütfen geçerli bir 'Sipariş Tarihi' seçiniz.",
                "alert_deliveryDateInvalid": "Lütfen 'Talep Edilen Teslim Tarihi' seçiniz.",
                "alert_branchNameInvalid": "Lütfen geçerli bir 'Şube Adı' seçiniz veya giriniz.",
                "alert_noItemSelected": "Lütfen paylaşmadan/göndermeden önce en az bir ürün için miktar belirtin.",
                "searchPlaceholder": "Ara...",
                "manualBranchNotSpecified": "Belirtilmedi (Manuel)", "selectionBranchNotSpecified": "Belirtilmedi (Seçim)",
                "summaryUnitLB": "LB", "summaryUnitPCS": "Adet", "summaryUnitQuart": "Quart",
                "summaryUnitKunefeSmall": "Küçük", "summaryUnitKunefeLarge": "Büyük", "summaryUnitManual": "(M)",
                "loginTitle": "Giriş Yap", "usernamePlaceholder": "Kullanıcı Adı", "passwordPlaceholder": "Şifre",
                "loginButtonText": "GİRİŞ", "rememberMeLabel": "Beni Hatırla",
                "alert_loginFailed": "Kullanıcı adı veya şifre hatalı.",
                "alert_loginFieldsMissing": "Kullanıcı adı ve şifre alanları doldurulmalıdır.",
                "shareModalTitle": "Sipariş Formunu Paylaş",
                "shareModalMessage": "Dosya(lar) hazırlanıyor, lütfen bekleyin...",
                "shareModalMessageReady": "Dosya paylaşıma hazır veya aşağıdaki seçenekleri kullanın:",
                "downloadPdfButton": "PDF İndir", "downloadWordButton": "Word Olarak İndir",
                "wordGenerationFailed": "Word dosyası oluşturulamadı. Lütfen tekrar deneyin.",
                "pdfGenerationFailed": "PDF oluşturulamadı. Lütfen tekrar deneyin.",
                "closeButton": "Kapat",
                "webShareNotSupported": "Tarayıcınız doğrudan dosya paylaşımını desteklemiyor. Dosyayı indirip manuel olarak paylaşabilirsiniz."
            },
            "en": {
                "pageTitle": "Selda Mediterranean - Product Order Form", "orderFormTitle": "PRODUCT ORDER FORM",
                "orderNoLabel": "Order No:", "orderDateLabel": "Order Date:",
                "authorizedPersonLabel": "Authorized Person:", "authPersonPlaceholder": "Your Name",
                "branchNameLabel": "Branch Name:", "manualBranchCheckboxTitle": "Enter Branch Name Manually",
                "manualBranchInputPlaceholder": "Enter branch name here...",
                "requestedDeliveryDateLabel": "Requested Delivery Date:",
                "contactPhoneLabel": "Contact Phone (Branch):", "contactPhonePlaceholder": "Branch phone number",
                "productNameHeader": "Product Name", "lbHeader": "Pound (LB)", "pcsUnitHeader": "PCS",
                "quartHeader": "Quart", "kunefeSmallHeader": "Small", "kunefeLargeHeader": "Large",
                "otherLabel": "Other:", "generalNotesTitle": "GENERAL NOTES", "generalNotesTitleHeader": "NOTES", // Added for print header
                "generalNotesPlaceholder": "Your general notes about the order...",
                "printButton": "PRINT", "sendOrderButton": "SEND E-MAIL", "shareButtonText": "SHARE",
                "orderSummaryTitle": "Order Summary", "emptySummaryText": "No products selected yet.",
                "totalLbLabel": "Total LB:", "totalPcsLabel": "Total PCS:", "totalQuartLabel": "Total Quart:",
                "footerCompanyName": "Selda Mediterranean - Central Kitchen",
                "alert_authPersonMissing": "Please enter the 'Authorized Person' name.",
                "alert_orderDateInvalid": "Please select a valid 'Order Date'.",
                "alert_deliveryDateInvalid": "Please select a 'Requested Delivery Date'.",
                "alert_branchNameInvalid": "Please select or enter a valid 'Branch Name'.",
                "alert_noItemSelected": "Please specify a quantity for at least one product before sharing/sending.",
                "searchPlaceholder": "Search...",
                "manualBranchNotSpecified": "Not Specified (Manual)", "selectionBranchNotSpecified": "Not Specified (Selection)",
                "summaryUnitLB": "LB", "summaryUnitPCS": "PCS", "summaryUnitQuart": "Quart",
                "summaryUnitKunefeSmall": "Small", "summaryUnitKunefeLarge": "Large", "summaryUnitManual": "(M)",
                "loginTitle": "Login", "usernamePlaceholder": "Username", "passwordPlaceholder": "Password",
                "loginButtonText": "LOGIN", "rememberMeLabel": "Remember Me",
                "alert_loginFailed": "Invalid username or password.",
                "alert_loginFieldsMissing": "Username and password fields must be filled.",
                "shareModalTitle": "Share Order Form",
                "shareModalMessage": "Generating file(s), please wait...",
                "shareModalMessageReady": "File is ready for sharing or use options below:",
                "downloadPdfButton": "Download PDF", "downloadWordButton": "Download as Word",
                "wordGenerationFailed": "Failed to generate Word file. Please try again.",
                "pdfGenerationFailed": "Failed to generate PDF. Please try again.",
                "closeButton": "Close",
                "webShareNotSupported": "Your browser does not support direct file sharing. You can download the file and share it manually."
            }
        };
        let currentLanguage = 'en';

        const productData = {
            "SMALL BITES": ["Soup of the Day", "Hummus", "Grilled Eggplant Salad(Babagannus)", "Tzatziki (Cacik)", "Spicy Ezme", "Saksuka", "Cigar Borek", "Stuffed Dates", "Salmon and Grape Leaves", "Arnavut Cigeri", "Ali Nazik (Sauce)","Avakado Sauce", "White Sauce(yogurt)", "Tomato Sauce", "Shiracha Sauce"],
            "A LITTLE MORE": ["Vegetarian Couscous", "Chicken Shish", "Chicken Adana", "Urfa Kebab", "Beef Shish", "Grilled Pistachio Meatballs", "Lamb Chops", "Lamb Shank", "Grilled Salmon", "Lamb Shish"],
            "FROM THE OVEN": ["Vegetarian Pide", "Cheese Pide", "Meat Pide", "Spinach Feta Pide", "Lahmacun"],
            "DESSERT": ["Quinn", "Fistikli Mousse", "Vanilia Mousse", "Kunefe", "Turkish Flan", "Trilece", "San Sebastian", "Profiterol", "Chocolate Fistikli", "Lotus", "Oreo", "Tart", "Malaga", "Sutlac"]
        };
        const BRANCH_OPTIONS = [ "SELDA - Belt Line", "SELDA - The Mayor's", "SELDA - San Antonio", "SELDA - Frisco", "SELDA - Doner" ];

        const PCS_ONLY_PRODUCTS_SMALL_BITES = ["Cigar Borek", "Stuffed Dates", "Salmon and Grape Leaves"];
        const LB_AND_PCS_PRODUCTS_A_LITTLE_MORE = []; 


        const LS_LANGUAGE = 'seldaOrderForm_language_v8_final_touches_v2';
        const LS_SENDER_NAME = 'seldaOrderForm_senderName_v12';
        const LS_CONTACT_PHONE = 'seldaOrderForm_contactPhone_v12';
        const LS_BRANCH_SELECT_VALUE = 'seldaOrderForm_branchSelectValue_v12';
        const LS_MANUAL_BRANCH_VALUE = 'seldaOrderForm_manualBranchValue_v12';
        const LS_MANUAL_BRANCH_ENABLED = 'seldaOrderForm_manualBranchEnabled_v12';
        const LS_ORDER_DATE = 'seldaOrderForm_orderDate_v12';
        const LS_DELIVERY_DATE = 'seldaOrderForm_deliveryDate_v12';
        const LS_ORDER_COUNTER = 'seldaOrderCounterV20_final_touches_v2';


        function assignLoginDOMElements() {
            loginScreen = document.getElementById('loginScreen');
            usernameInput = document.getElementById('username');
            passwordInput = document.getElementById('password');
            rememberMeCheckbox = document.getElementById('rememberMeCheckbox');
            loginButton = document.getElementById('loginButton');
            loginError = document.getElementById('loginError');
            pageWrapper = document.querySelector('.page-wrapper');
        }

        function assignMainFormDOMElements() {
            orderSenderNameInput = document.getElementById('orderSenderName');
            contactPhoneInput = document.getElementById('contactPhone');
            branchSelect = document.getElementById('branchSelect');
            manualBranchCheckbox = document.getElementById('manualBranchCheckbox');
            manualBranchInput = document.getElementById('manualBranchInput');
            orderDateInput = document.getElementById('orderDate');
            deliveryDateInput = document.getElementById('deliveryDate');
            orderNoInput = document.getElementById('orderNo');
            generalNotesInput = document.getElementById('generalNotes');
            mainFormLangTrBtn = document.getElementById('langTrBtn');
            mainFormLangEnBtn = document.getElementById('langEnBtn');
            printButton = document.querySelector('.print-btn');
            sendEmailBtn = document.getElementById('sendEmailBtn');
            shareButton = document.getElementById('shareButton');
            shareOptionsModal = document.getElementById('shareOptionsModal');
            closeShareModalButton = document.getElementById('closeShareModalButton');
            downloadPdfButton = document.getElementById('downloadPdfButton');
            downloadWordButton = document.getElementById('downloadWordButton');
            shareModalMessage = document.getElementById('shareModalMessage');
            shareButtonsContainer = document.getElementById('shareButtonsContainer');
        }

        function showLoginScreen() {
            if (loginScreen) loginScreen.classList.remove('hidden');
            if (pageWrapper) pageWrapper.style.display = 'none';
            if (usernameInput) usernameInput.focus();
        }

        function showMainForm() {
            if (loginScreen) loginScreen.classList.add('hidden');
            if (pageWrapper) pageWrapper.style.display = 'flex';
        }

        function checkAuth() {
            if (sessionStorage.getItem(AUTH_KEY_SESSION) === 'true') {
                showMainForm();
                if (!mainFormInitialized) {
                    initializeMainForm();
                }
                return true;
            }
            showLoginScreen();
            return false;
        }

        function handleLogin() {
            const enteredUsername = usernameInput.value.trim();
            const enteredPassword = passwordInput.value.trim();
            const langSet = translations[currentLanguage] || translations.en;

            if (!enteredUsername || !enteredPassword) {
                loginError.textContent = langSet.alert_loginFieldsMissing;
                loginError.style.display = 'block';
                return;
            }

            if (enteredUsername === CORRECT_USERNAME && enteredPassword === CORRECT_PASSWORD) {
                sessionStorage.setItem(AUTH_KEY_SESSION, 'true');
                loginError.style.display = 'none';

                if (rememberMeCheckbox.checked) {
                    try {
                        localStorage.setItem(LS_REMEMBER_USER, 'true');
                        localStorage.setItem(LS_REMEMBERED_USERNAME, enteredUsername);
                        localStorage.setItem(LS_REMEMBERED_PASSWORD, enteredPassword);
                    } catch (e) { console.warn("localStorage 'Beni Hatırla' kaydı başarısız:", e); }
                } else {
                    try {
                        localStorage.removeItem(LS_REMEMBER_USER);
                        localStorage.removeItem(LS_REMEMBERED_USERNAME);
                        localStorage.removeItem(LS_REMEMBERED_PASSWORD);
                    } catch (e) { console.warn("localStorage 'Beni Hatırla' silme başarısız:", e); }
                }
                showMainForm();
                if (!mainFormInitialized) {
                     initializeMainForm();
                }
            } else {
                loginError.textContent = langSet.alert_loginFailed;
                loginError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function loadRememberMe() {
            try {
                const rememberUser = localStorage.getItem(LS_REMEMBER_USER);
                if (rememberUser === 'true') {
                    const rememberedUsername = localStorage.getItem(LS_REMEMBERED_USERNAME);
                    const rememberedPassword = localStorage.getItem(LS_REMEMBERED_PASSWORD);

                    if (rememberedUsername && usernameInput) {
                        usernameInput.value = rememberedUsername;
                    }
                    if (rememberedPassword && passwordInput) {
                        passwordInput.value = rememberedPassword;
                    }
                    if (rememberMeCheckbox) {
                        rememberMeCheckbox.checked = true;
                    }

                    if(usernameInput.value && passwordInput.value) {
                        if(loginButton) loginButton.focus();
                    } else if (usernameInput.value && !passwordInput.value) {
                        if(passwordInput) passwordInput.focus();
                    } else {
                         if(usernameInput) usernameInput.focus();
                    }
                } else {
                    if (rememberMeCheckbox) {
                        rememberMeCheckbox.checked = false;
                    }
                    if (usernameInput) usernameInput.focus();
                }
            } catch (e) {
                console.warn("localStorage 'Beni Hatırla' okuma başarısız:", e);
            }
        }


        function setLanguage(lang) {
            currentLanguage = lang;
            try { localStorage.setItem(LS_LANGUAGE, lang); } catch(e) { console.warn("localStorage dil kaydı başarısız:", e); }
            if (document.documentElement) document.documentElement.lang = lang;
            updateUIForLanguage(lang);
            if (mainFormInitialized && mainFormLangTrBtn && mainFormLangEnBtn) {
                mainFormLangTrBtn.classList.toggle('active', lang === 'tr');
                mainFormLangEnBtn.classList.toggle('active', lang === 'en');
            }
        }

        function updateUIForLanguage(lang) {
            const translationSet = translations[lang] || translations.en;
            if (!translationSet) return;
            if(document) document.title = translationSet.pageTitle;

            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translationSet[key]) el.textContent = translationSet[key];
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                if (translationSet[key]) el.placeholder = translationSet[key];
            });
            document.querySelectorAll('[data-translate-title]').forEach(el => {
                const key = el.dataset.translateTitle;
                if (translationSet[key]) el.title = translationSet[key];
            });

            if (loginError && loginError.style.display !== 'none') {
                 if (loginError.textContent.includes("hatalı") || loginError.textContent.includes("Invalid")) {
                     loginError.textContent = translationSet.alert_loginFailed;
                 } else if (loginError.textContent.includes("doldurulmalıdır") || loginError.textContent.includes("must be filled")) {
                     loginError.textContent = translationSet.alert_loginFieldsMissing;
                 }
            }

            if (mainFormInitialized) {
                renderProducts();
                updateOrderSummary();
            }
        }

        function loadLanguage() {
            let savedLang = 'en';
            try {
                const langFromStorage = localStorage.getItem(LS_LANGUAGE);
                if (langFromStorage === 'tr' || langFromStorage === 'en') {
                    savedLang = langFromStorage;
                }
            } catch(e) {
                console.warn("localStorage dil okuma başarısız, İngilizce'ye dönülüyor:", e);
            }
            setLanguage(savedLang);
        }

        function formatDateForInput(date) {
            if (!(date instanceof Date) || isNaN(date.valueOf())) date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(dateString, locale = 'en-US') {
            if (!dateString) return 'N/A';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                const dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                if (!isNaN(dateObj.getTime())) {
                    return dateObj.toLocaleDateString(locale, { month: '2-digit', day: '2-digit', year: 'numeric' });
                }
            }
            return 'N/A';
        }
        
        function formatDateForFileName(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${day}-${year}`; 
        }


        function renderProducts() {
            const container = document.getElementById('productSectionsContainer');
            if (!container) return;
            let htmlContent = '';
            const langSet = translations[currentLanguage] || translations.en;

            Object.keys(productData).forEach((category) => {
                const categoryId = `category-${category.replace(/\s+/g, '').toLowerCase()}`;
                let headerRow;
                const isDessertCategory = category === "DESSERT";

                if (isDessertCategory) {
                     headerRow = `
                        <th>${langSet.productNameHeader}</th>
                        <th class="dessert-pcs-header" colspan="2" style="text-align:center;">${langSet.pcsUnitHeader}</th>`;
                } else {
                    headerRow = `
                        <th>${langSet.productNameHeader}</th>
                        <th style="width: 200px;">${langSet.lbHeader}</th>
                        <th style="width: 200px;">${langSet.pcsUnitHeader}</th>`;
                }


                htmlContent += `
                    <div class="section-title collapsed" role="button" tabindex="0" data-category-id="${categoryId}" aria-expanded="false" aria-controls="${categoryId}">
                        <span class="category-title-text">${category.toUpperCase()}</span>
                        <div class="category-search-container">
                            <input type="text" class="category-search-box" placeholder="${langSet.searchPlaceholder}" onclick="event.stopPropagation();">
                        </div>
                        <span class="toggle-icon" aria-hidden="true"></span>
                    </div>
                    <div class="product-table-wrapper" id="${categoryId}">
                        <table class="product-table">
                            <thead><tr>${headerRow}</tr></thead>
                            <tbody>`;

                productData[category].forEach(productName => {
                    const safeProductName = productName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
                    const baseId = `prod-${category.replace(/\s+/g, '')}-${safeProductName}`;
                    let column1Html = ''; 
                    let column2Html = ''; 
                    const isFromOvenCategory = category === "FROM THE OVEN";

                    if (isDessertCategory) {
                        if (productName === "Kunefe") {
                            column1Html = `
                            <div class="kunefe-options-container">
                                <div class="kunefe-options-group">
                                    <span class="size-label">${langSet.kunefeSmallHeader}</span>
                                    <div class="quantity-options" data-unit="Adet" data-size="Small">
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-small-adet" value="5"> 5</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-small-adet" value="10"> 10</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-small-adet" value="15"> 15</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-small-adet" value="20"> 20</label>
                                        <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-small-adet-manual" min="0" step="1"></label>
                                    </div>
                                </div>
                                <div class="kunefe-options-group">
                                    <span class="size-label">${langSet.kunefeLargeHeader}</span>
                                    <div class="quantity-options" data-unit="Adet" data-size="Large">
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-large-adet" value="5"> 5</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-large-adet" value="10"> 10</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-large-adet" value="15"> 15</label>
                                        <label><input type="checkbox" class="qty-cb" name="${baseId}-large-adet" value="20"> 20</label>
                                        <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-large-adet-manual" min="0" step="1"></label>
                                    </div>
                                </div>
                            </div>`;
                        } else if (productName === "Baklava") {
                            column1Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="1"> 1</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="2"> 2</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="3"> 3</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="4"> 4</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        } else { 
                            column1Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        }
                        column2Html = ''; 
                    } else if (productName === "Soup of the Day") {
                        column1Html = `
                        <div>
                            <span class="specific-unit-label">${langSet.quartHeader}</span>
                            <div class="quantity-options" data-unit="Quart">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-quart" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-quart" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-quart" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-quart" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-quart-manual" min="0" step="any"></label>
                            </div>
                        </div>`;
                        column2Html = `<div>-</div>`;
                    } else if (isFromOvenCategory) {
                        column1Html = `
                        <div class="quantity-options" data-unit="LB">
                            <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="5"> 5</label>
                            <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="10"> 10</label>
                            <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="15"> 15</label>
                            <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="20"> 20</label>
                            <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-lb-manual" min="0" step="any"></label>
                        </div>`;
                        column2Html = `<div>-</div>`;
                    } else if (category === "SMALL BITES") {
                        if (PCS_ONLY_PRODUCTS_SMALL_BITES.includes(productName)) {
                            column1Html = `<div>-</div>`;
                            column2Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="50"> 50</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="100"> 100</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="150"> 150</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="200"> 200</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        } else { 
                            column1Html = `
                            <div class="quantity-options" data-unit="LB">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-lb-manual" min="0" step="any"></label>
                            </div>`;
                            column2Html = `<div>-</div>`;
                        }
                    } else if (category === "A LITTLE MORE") {
                        if (productName === "Lamb Shank") {
                             column1Html = `<div>-</div>`; 
                             column2Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        } else if (productName === "Grilled Salmon") {
                            column1Html = `<div>-</div>`; // No LB options for Grilled Salmon
                            column2Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="20"> 20</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="30"> 30</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="40"> 40</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="50"> 50</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        } else if (LB_AND_PCS_PRODUCTS_A_LITTLE_MORE.includes(productName)) {
                            column1Html = `
                            <div class="quantity-options" data-unit="LB">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-lb-manual" min="0" step="any"></label>
                            </div>`;
                            column2Html = `
                            <div class="quantity-options" data-unit="Adet">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="50"> 50</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="100"> 100</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="150"> 150</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-adet" value="200"> 200</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-adet-manual" min="0" step="1"></label>
                            </div>`;
                        } else { 
                             column1Html = `
                            <div class="quantity-options" data-unit="LB">
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="5"> 5</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="10"> 10</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="15"> 15</label>
                                <label><input type="checkbox" class="qty-cb" name="${baseId}-lb" value="20"> 20</label>
                                <label><span class="qty-label-text">${langSet.otherLabel}</span> <input type="number" class="manual-qty-input" name="${baseId}-lb-manual" min="0" step="any"></label>
                            </div>`;
                            column2Html = `<div>-</div>`;
                        }
                    }

                    htmlContent += `
                                <tr class="product-row" data-product-name="${productName.toLowerCase()}" data-category-title-id="${categoryId}" id="row-${baseId}">
                                    <td>${productName}</td>
                                    <td ${isDessertCategory ? 'colspan="2"' : ''}>${column1Html}</td>`;
                    if (!isDessertCategory) {
                        htmlContent += `<td>${column2Html}</td>`;
                    }
                    htmlContent += `</tr>`;
                });
                htmlContent += '</tbody></table></div>';
            });
            container.innerHTML = htmlContent;
            attachProductEventListeners();
        }


        function updateOrderSummary() {
            const summaryList = document.getElementById('summaryList');
            const emptySummaryText = document.getElementById('emptySummaryText');
            const totalLbEl = document.getElementById('totalLb');
            const totalAdetEl = document.getElementById('totalAdet');
            const totalQuartEl = document.getElementById('totalQuart');
            const totalQuartRowEl = document.getElementById('totalQuartRow');

            if(!summaryList || !emptySummaryText || !totalLbEl || !totalAdetEl || !totalQuartEl || !totalQuartRowEl) return;

            const langSet = translations[currentLanguage] || translations.en;
            summaryList.innerHTML = '';
            let hasItemsInSummary = false;
            let currentTotalLb = 0;
            let currentTotalAdet = 0;
            let currentTotalQuart = 0;

            document.querySelectorAll('.section-title[data-category-id]').forEach(title => title.classList.remove('has-selection'));

            document.querySelectorAll('.product-row').forEach(row => {
                const productName = row.querySelector('td:first-child').textContent;
                const categoryId = row.dataset.categoryTitleId;
                const categoryTitleElement = document.querySelector(`.section-title[data-category-id="${categoryId}"]`);
                const categoryName = categoryTitleElement ? categoryTitleElement.querySelector('.category-title-text').textContent.toUpperCase() : "";
                const isDessertCategory = categoryName === "DESSERT";

                let summaryDetail = '';
                let isRowSelected = false;

                if (productName === "Kunefe") {
                    const kunefeCell = row.querySelector('td:nth-child(2)');
                    const smallOptions = kunefeCell.querySelector('.quantity-options[data-size="Small"]');
                    const largeOptions = kunefeCell.querySelector('.quantity-options[data-size="Large"]');
                    let kunefeSmallQty = 0;
                    let kunefeLargeQty = 0;

                    if (smallOptions) {
                        smallOptions.querySelectorAll('input.qty-cb:checked').forEach(cb => { kunefeSmallQty += parseInt(cb.value); isRowSelected = true; });
                        const smallManual = smallOptions.querySelector('.manual-qty-input');
                        if (smallManual && smallManual.value && parseInt(smallManual.value) > 0) { kunefeSmallQty += parseInt(smallManual.value); isRowSelected = true;}
                    }
                    if (largeOptions) {
                        largeOptions.querySelectorAll('input.qty-cb:checked').forEach(cb => { kunefeLargeQty += parseInt(cb.value); isRowSelected = true; });
                        const largeManual = largeOptions.querySelector('.manual-qty-input');
                        if (largeManual && largeManual.value && parseInt(largeManual.value) > 0) { kunefeLargeQty += parseInt(largeManual.value); isRowSelected = true;}
                    }

                    if (kunefeSmallQty > 0) {
                        summaryDetail += `${kunefeSmallQty} ${langSet.summaryUnitKunefeSmall} `;
                        if (smallOptions && smallOptions.querySelector('.manual-qty-input').value && parseInt(smallOptions.querySelector('.manual-qty-input').value) > 0 && smallOptions.querySelectorAll('input.qty-cb:checked').length === 0) summaryDetail += `${langSet.summaryUnitManual} `;
                    }
                    if (kunefeLargeQty > 0) {
                        summaryDetail += `${kunefeLargeQty} ${langSet.summaryUnitKunefeLarge} `;
                         if (largeOptions && largeOptions.querySelector('.manual-qty-input').value && parseInt(largeOptions.querySelector('.manual-qty-input').value) > 0 && largeOptions.querySelectorAll('input.qty-cb:checked').length === 0) summaryDetail += `${langSet.summaryUnitManual} `;
                    }
                    currentTotalAdet += kunefeSmallQty + kunefeLargeQty;

                } else if (isDessertCategory) {
                    const pcsOptions = row.querySelector('td:nth-child(2) .quantity-options');
                    if (pcsOptions) {
                        const unitType = pcsOptions.dataset.unit;
                        let qty = 0;
                        let isManual = false;
                        pcsOptions.querySelectorAll('input.qty-cb:checked').forEach(cb => { qty += parseInt(cb.value); isRowSelected = true; });
                        const manual = pcsOptions.querySelector('.manual-qty-input');
                        if (manual && manual.value && parseInt(manual.value) > 0) { qty += parseInt(manual.value); isRowSelected = true; isManual = true;}
                        
                        if (qty > 0) {
                           if (unitType === "Adet") { summaryDetail += `${qty} ${langSet.summaryUnitPCS} `; currentTotalAdet += qty; }
                           if(isManual && pcsOptions.querySelectorAll('input.qty-cb:checked').length === 0) summaryDetail += `${langSet.summaryUnitManual} `;
                        }
                    }
                } else {
                    const column1Cell = row.querySelector('td:nth-child(2)');
                    const column2Cell = row.querySelector('td:nth-child(3)');
                    const column1Options = column1Cell ? column1Cell.querySelector('.quantity-options') : null;
                    const column2Options = column2Cell ? column2Cell.querySelector('.quantity-options') : null;

                    if (column1Options) {
                        const unitType = column1Options.dataset.unit;
                        let qty = 0;
                        let isManual = false;
                        column1Options.querySelectorAll('input.qty-cb:checked').forEach(cb => { qty += parseFloat(cb.value); isRowSelected = true; });
                        const manual = column1Options.querySelector('.manual-qty-input');
                        if (manual && manual.value && parseFloat(manual.value) > 0) { qty += parseFloat(manual.value); isRowSelected = true; isManual = true;}

                        if (qty > 0) {
                            if (unitType === "Quart") { summaryDetail += `${qty} ${langSet.summaryUnitQuart} `; currentTotalQuart += qty; }
                            else if (unitType === "LB") { summaryDetail += `${qty} ${langSet.summaryUnitLB} `; currentTotalLb += qty; }
                            if(isManual && column1Options.querySelectorAll('input.qty-cb:checked').length === 0) summaryDetail += `${langSet.summaryUnitManual} `;
                        }
                    }
                    if (column2Options && column2Options.children.length > 0 && column2Options.firstElementChild.tagName !== 'DIV') {
                        const unitType = column2Options.dataset.unit;
                        if (unitType === "Adet") {
                            let qty = 0;
                            let isManual = false;
                            column2Options.querySelectorAll('input.qty-cb:checked').forEach(cb => { qty += parseInt(cb.value); isRowSelected = true; });
                            const manual = column2Options.querySelector('.manual-qty-input');
                            if (manual && manual.value && parseInt(manual.value) > 0) { qty += parseInt(manual.value); isRowSelected = true; isManual = true;}
                            
                            if (qty > 0) {
                               summaryDetail += `${qty} ${langSet.summaryUnitPCS} `; currentTotalAdet += qty;
                               if(isManual && column2Options.querySelectorAll('input.qty-cb:checked').length === 0) summaryDetail += `${langSet.summaryUnitManual} `;
                            }
                        }
                    }
                }

                if (isRowSelected) {
                    row.classList.add('selected-row');
                    if (categoryTitleElement) categoryTitleElement.classList.add('has-selection');
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="summary-product-name">${productName}</span> <span class="summary-product-qty">${summaryDetail.trim()}</span>`;
                    summaryList.appendChild(listItem);
                    hasItemsInSummary = true;
                } else {
                    row.classList.remove('selected-row');
                }
            });

            emptySummaryText.style.display = hasItemsInSummary ? 'none' : 'block';
            totalLbEl.textContent = `${currentTotalLb.toFixed(2)} ${langSet.summaryUnitLB}`;
            totalAdetEl.textContent = `${currentTotalAdet} ${langSet.summaryUnitPCS}`;
            totalQuartEl.textContent = `${currentTotalQuart.toFixed(2)} ${langSet.summaryUnitQuart}`;

            totalQuartRowEl.style.display = currentTotalQuart > 0 ? 'flex' : 'none';
        }


        function attachProductEventListeners() {
            document.querySelectorAll('.section-title[data-category-id]').forEach((title) => {
                const toggleCategory = () => { title.classList.toggle('collapsed'); title.setAttribute('aria-expanded', !title.classList.contains('collapsed')); };
                title.addEventListener('click', (event) => { if (!event.target.classList.contains('category-search-box')) toggleCategory(); });
                title.addEventListener('keydown', (event) => { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); if (!event.target.classList.contains('category-search-box')) toggleCategory();}});

                const searchBox = title.querySelector('.category-search-box');
                const productTableWrapper = document.getElementById(title.dataset.categoryId);
                if (searchBox && productTableWrapper) {
                    searchBox.addEventListener('keyup', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        const productRows = productTableWrapper.querySelectorAll('.product-row');
                        let foundInThisCategory = false;
                        productRows.forEach(row => {
                            const productName = row.dataset.productName;
                            if (productName.includes(searchTerm)) { row.classList.remove('hidden-by-search'); foundInThisCategory = true; }
                            else { row.classList.add('hidden-by-search'); }
                        });
                        if (searchTerm !== "" && foundInThisCategory && title.classList.contains('collapsed')) { toggleCategory(); }
                    });
                }
            });
            document.querySelectorAll('.quantity-options input.qty-cb, .manual-qty-input').forEach(input => {
                const eventType = input.type === 'checkbox' ? 'change' : 'input';
                input.addEventListener(eventType, function() {
                    const group = this.closest('.quantity-options');
                    if (this.type === 'checkbox' && this.checked) {
                        group.querySelectorAll('input.qty-cb').forEach(otherCb => { if (otherCb !== this) otherCb.checked = false; });
                        const manualInput = group.querySelector('.manual-qty-input'); if(manualInput) manualInput.value = '';
                    } else if (this.classList.contains('manual-qty-input') && this.value && ( (this.step === "any" && parseFloat(this.value) > 0) || (this.step === "1" && parseInt(this.value) > 0) ) ) {
                         group.querySelectorAll('input.qty-cb').forEach(cb => { cb.checked = false; });
                    }
                    updateOrderSummary();
                });
            });
        }

        function populateBranchSelect() { if(!branchSelect) return; branchSelect.innerHTML = ''; BRANCH_OPTIONS.forEach(text => { const opt = document.createElement('option'); opt.value = text; opt.textContent = text; branchSelect.appendChild(opt); });}
        function updateBranchInputState() { if(!manualBranchCheckbox || !manualBranchInput || !branchSelect) return; const isManual = manualBranchCheckbox.checked; manualBranchInput.style.display = isManual ? 'block' : 'none'; manualBranchInput.disabled = !isManual; branchSelect.disabled = isManual;}
        function getCurrentBranchName() { const langSet = translations[currentLanguage] || translations.en; if(!manualBranchCheckbox || !manualBranchInput || !branchSelect) return langSet.selectionBranchNotSpecified; if (manualBranchCheckbox.checked) return manualBranchInput.value.trim() || langSet.manualBranchNotSpecified; return branchSelect.value || langSet.selectionBranchNotSpecified;}

        function saveFormSetting(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.warn(`localStorage '${key}' kaydı başarısız:`, e); }}
        function loadFormSettings() {
            if(!mainFormInitialized) return;
            try {
                orderSenderNameInput.value = localStorage.getItem(LS_SENDER_NAME) || '';
                contactPhoneInput.value = localStorage.getItem(LS_CONTACT_PHONE) || '';
                const savedBranch = localStorage.getItem(LS_BRANCH_SELECT_VALUE); if (savedBranch && branchSelect) branchSelect.value = savedBranch;
                if(manualBranchInput) manualBranchInput.value = localStorage.getItem(LS_MANUAL_BRANCH_VALUE) || '';
                if(manualBranchCheckbox) manualBranchCheckbox.checked = localStorage.getItem(LS_MANUAL_BRANCH_ENABLED) === 'true';
            } catch (e) { console.warn("localStorage ayarları yüklenirken hata:", e); }
            updateBranchInputState();
        }

        function setInitialDates() {
            if(!mainFormInitialized || !orderDateInput || !deliveryDateInput) return;
            orderDateInput.value = formatDateForInput(new Date());
            let savedDeliveryDate = null;
            try {
                savedDeliveryDate = localStorage.getItem(LS_DELIVERY_DATE);
            } catch (e) { console.warn("localStorage teslim tarihi okuma hatası:", e); }

            if (savedDeliveryDate) {
                deliveryDateInput.value = savedDeliveryDate;
            } else {
                let orderDateVal;
                const parts = orderDateInput.value.split('-');
                if (parts.length === 3) {
                    orderDateVal = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                } else {
                    console.error("setInitialDates içinde orderDateInput.value ayrıştırılamadı.");
                    orderDateVal = new Date();
                }
                if (isNaN(orderDateVal.getTime())) {
                     console.error("setInitialDates içinde orderDateVal geçersiz.");
                    orderDateVal = new Date();
                }
                const tomorrow = new Date(orderDateVal);
                tomorrow.setDate(orderDateVal.getDate() + 1);
                deliveryDateInput.value = formatDateForInput(tomorrow);
                saveFormSetting(LS_DELIVERY_DATE, deliveryDateInput.value);
            }
        }


        function setFooterInfo() { if(!mainFormInitialized) return; const addr = document.getElementById('footerCompanyAddress'); const phone = document.getElementById('footerCompanyPhone'); if(addr) addr.textContent = COMPANY_ADDRESS_PRINT; if(phone) phone.textContent = COMPANY_PHONE_PRINT;}
        function setDeveloperSignature() { if(!mainFormInitialized) return; const devSign = document.querySelector('.developer-signature'); if (devSign) devSign.innerHTML = `Developed by K.E.`;}

        function validateOrderForm() {
            const langSet = translations[currentLanguage] || translations.en;
            if (!orderSenderNameInput.value.trim()) { alert(langSet.alert_authPersonMissing); orderSenderNameInput.focus(); return false; }
            if (!orderDateInput.value || formatDateForDisplay(orderDateInput.value) === 'N/A') { alert(langSet.alert_orderDateInvalid); orderDateInput.focus(); return false; }
            if (!deliveryDateInput.value || formatDateForDisplay(deliveryDateInput.value) === 'N/A') { alert(langSet.alert_deliveryDateInvalid); deliveryDateInput.focus(); return false; }
            const currentBranch = getCurrentBranchName();
            if (!currentBranch || currentBranch === langSet.manualBranchNotSpecified || currentBranch === langSet.selectionBranchNotSpecified) { alert(langSet.alert_branchNameInvalid); if (manualBranchCheckbox.checked) manualBranchInput.focus(); else branchSelect.focus(); return false; }
            if (document.querySelectorAll('#summaryList li').length === 0) { alert(langSet.alert_noItemSelected); return false; }
            return true;
        }

        function getOrderDetails(forTextSummary = false) {
            const langSet = translations[currentLanguage] || translations.en;
            const notesValue = generalNotesInput ? generalNotesInput.value.trim() : '';
            const details = {
                orderNo: orderNoInput ? orderNoInput.value : 'N/A',
                orderDate: orderDateInput ? orderDateInput.value : '',
                senderName: orderSenderNameInput ? (orderSenderNameInput.value.trim() || 'N/A') : 'N/A',
                branchName: getCurrentBranchName().replace(langSet.manualBranchNotSpecified, "Not Specified (Manual)").replace(langSet.selectionBranchNotSpecified, "Not Specified (Selection)"),
                contactPhone: contactPhoneInput ? (contactPhoneInput.value.trim() || 'N/A') : 'N/A',
                deliveryDate: deliveryDateInput ? deliveryDateInput.value : '',
                generalNotes: notesValue || (forTextSummary && !notesValue ? 'None' : ''), // Ensure empty string if no notes, 'None' only for text summary if truly empty
                totalLbText: document.getElementById('totalLb') ? document.getElementById('totalLb').textContent : `0 ${langSet.summaryUnitLB}`,
                totalPcsText: document.getElementById('totalAdet') ? document.getElementById('totalAdet').textContent : `0 ${langSet.summaryUnitPCS}`,
                totalQuartText: document.getElementById('totalQuart') ? document.getElementById('totalQuart').textContent : `0 ${langSet.summaryUnitQuart}`,
                summaryItems: Array.from(document.querySelectorAll('#summaryList li')).map(item => ({
                    name: item.querySelector('.summary-product-name').textContent,
                    quantity: item.querySelector('.summary-product-qty').textContent
                }))
            };
            const displayLocale = currentLanguage === 'tr' ? 'tr-TR' : 'en-US';
            details.formattedOrderDate = formatDateForDisplay(details.orderDate, 'en-US');
            details.displayOrderDate = formatDateForDisplay(details.orderDate, displayLocale);
            details.formattedDeliveryDate = formatDateForDisplay(details.deliveryDate, 'en-US');
            details.displayDeliveryDate = formatDateForDisplay(details.deliveryDate, displayLocale);
            return details;
        }


        function generatePrintContent(forPdfOrWord = false) {
            const details = getOrderDetails(); // forPdfOrWord flag is not needed by getOrderDetails for this logic
            const enLangSet = translations.en; // Use English for structural consistency in PDF/Word
            const currentLangSet = translations[currentLanguage] || translations.en;

            const companyNamePrint = translations['en'].footerCompanyName; // Use EN version for consistency
            
            let logoSrcToUse = '';
            const logoImgElement = document.querySelector('.page-header img');
            if (logoImgElement) {
                if (logoImgElement.src.startsWith('data:image') || logoImgElement.src.includes('via.placeholder.com')) {
                    logoSrcToUse = logoImgElement.src;
                } else if (logoImgElement.complete && logoImgElement.naturalWidth !== 0) {
                    logoSrcToUse = logoImgElement.src;
                } else {
                    logoSrcToUse = 'https://via.placeholder.com/160x60?text=Selda+Logo'; // Fallback
                }
            } else {
                 logoSrcToUse = 'https://via.placeholder.com/160x60?text=Selda+Logo';
            }

            let usedUnits = { lb: false, quart: false, pcs: false, kunefeSmall: false, kunefeLarge: false };
            details.summaryItems.forEach(item => {
                if (item.quantity.includes(enLangSet.summaryUnitLB) || item.quantity.includes(translations.tr.summaryUnitLB)) usedUnits.lb = true;
                if (item.quantity.includes(enLangSet.summaryUnitQuart) || item.quantity.includes(translations.tr.summaryUnitQuart)) usedUnits.quart = true;
                if (item.quantity.includes(enLangSet.summaryUnitPCS) || item.quantity.includes(translations.tr.summaryUnitPCS)) usedUnits.pcs = true;
                if (item.name === "Kunefe" && (item.quantity.includes(enLangSet.summaryUnitKunefeSmall) || item.quantity.includes(translations.tr.summaryUnitKunefeSmall))) usedUnits.kunefeSmall = true;
                if (item.name === "Kunefe" && (item.quantity.includes(enLangSet.summaryUnitKunefeLarge) || item.quantity.includes(translations.tr.summaryUnitKunefeLarge))) usedUnits.kunefeLarge = true;
            });


            let headerHtml = `<th class="product-name-col">${enLangSet.productNameHeader}</th>`;
            if (usedUnits.lb) headerHtml += `<th class="lb-col">${enLangSet.lbHeader}</th>`;
            if (usedUnits.quart) headerHtml += `<th class="quart-col">${enLangSet.quartHeader}</th>`;
            if (usedUnits.pcs) headerHtml += `<th class="pcs-col">${enLangSet.pcsUnitHeader}</th>`;
            if (usedUnits.kunefeSmall) headerHtml += `<th class="kunefe-s-col">${enLangSet.kunefeSmallHeader}</th>`;
            if (usedUnits.kunefeLarge) headerHtml += `<th class="kunefe-l-col">${enLangSet.kunefeLargeHeader}</th>`;
             if (!usedUnits.lb && !usedUnits.quart && !usedUnits.pcs && !usedUnits.kunefeSmall && !usedUnits.kunefeLarge && details.summaryItems.length > 0 && !headerHtml.includes("Quantity")) { // Check if any unit based header was added
                 headerHtml += `<th class="unit-col">Quantity</th>`;
            }


            let productRowsHtml = '';
            if (details.summaryItems.length > 0) {
                details.summaryItems.forEach(item => {
                    const productName = item.name;
                    const productQtyText = item.quantity; // This text is already localized and includes "(M)"
                    let rowDataHtml = `<td class="product-name-col">${productName}</td>`;

                    const extractQty = (text, unitEn, unitTr) => {
                        const regex = new RegExp(`([\\d\\.]+)\\s*(${unitEn}|${unitTr})`);
                        const match = text.match(regex);
                        if (match) {
                            return match[1] + (text.includes(enLangSet.summaryUnitManual) || text.includes(translations.tr.summaryUnitManual) ? " (M)" : "");
                        }
                        return '-';
                    };
                    
                    const extractKunefeQty = (text, sizeEn, sizeTr) => {
                        const regex = new RegExp(`(\\d+)\\s*(${sizeEn}|${sizeTr})`, 'i');
                        const match = text.match(regex);
                         if (match) {
                            return match[1] + (text.includes(enLangSet.summaryUnitManual) || text.includes(translations.tr.summaryUnitManual) ? " (M)" : "");
                        }
                        return '-';
                    };


                    if (usedUnits.lb) {
                        rowDataHtml += `<td class="lb-col">${extractQty(productQtyText, enLangSet.summaryUnitLB, translations.tr.summaryUnitLB)}</td>`;
                    }
                    if (usedUnits.quart) {
                        rowDataHtml += `<td class="quart-col">${extractQty(productQtyText, enLangSet.summaryUnitQuart, translations.tr.summaryUnitQuart)}</td>`;
                    }
                    if (usedUnits.pcs) {
                        let pcsVal = '-';
                        if (productName !== "Kunefe") { // Kunefe handled by specific columns if present
                            pcsVal = extractQty(productQtyText, enLangSet.summaryUnitPCS, translations.tr.summaryUnitPCS);
                        }
                        rowDataHtml += `<td class="pcs-col">${pcsVal}</td>`;
                    }
                    if (usedUnits.kunefeSmall) {
                         rowDataHtml += `<td class="kunefe-s-col">${productName === "Kunefe" ? extractKunefeQty(productQtyText, enLangSet.summaryUnitKunefeSmall, translations.tr.summaryUnitKunefeSmall) : '-'}</td>`;
                    }
                    if (usedUnits.kunefeLarge) {
                         rowDataHtml += `<td class="kunefe-l-col">${productName === "Kunefe" ? extractKunefeQty(productQtyText, enLangSet.summaryUnitKunefeLarge, translations.tr.summaryUnitKunefeLarge) : '-'}</td>`;
                    }
                    if (!usedUnits.lb && !usedUnits.quart && !usedUnits.pcs && !usedUnits.kunefeSmall && !usedUnits.kunefeLarge) {
                        rowDataHtml += `<td class="unit-col">${productQtyText}</td>`;
                    }
                    productRowsHtml += `<tr>${rowDataHtml}</tr>`;
                });
            } else {
                 let colspanCount = 1 + (usedUnits.lb?1:0) + (usedUnits.quart?1:0) + (usedUnits.pcs?1:0) + (usedUnits.kunefeSmall?1:0) + (usedUnits.kunefeLarge?1:0);
                 if (colspanCount === 1 && headerHtml.includes("Quantity")) colspanCount = 2; // Product Name + Quantity
                 else if (colspanCount === 1) colspanCount = 2; // Default if no units (should not happen if items exist)
                 
                 productRowsHtml = `<tr><td colspan="${colspanCount}" style="text-align:center;">No products ordered.</td></tr>`;
            }


            let totalsHtml = '';
            if (usedUnits.lb) totalsHtml += `<p style="margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline;"><span>Total Requested LB:</span><span style="margin-left:15px;">${details.totalLbText.replace(currentLangSet.summaryUnitLB, enLangSet.summaryUnitLB)}</span></p>`;
            if (usedUnits.quart) totalsHtml += `<p style="margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline;"><span>Total Requested Quart:</span><span style="margin-left:15px;">${details.totalQuartText.replace(currentLangSet.summaryUnitQuart, enLangSet.summaryUnitQuart)}</span></p>`;
            if (usedUnits.pcs || usedUnits.kunefeSmall || usedUnits.kunefeLarge) totalsHtml += `<p style="margin:4px 0;font-weight:700;display:flex;justify-content:flex-end;align-items:baseline;"><span>Total Requested PCS:</span><span style="margin-left:15px;">${details.totalPcsText.replace(currentLangSet.summaryUnitPCS, enLangSet.summaryUnitPCS)}</span></p>`;
            if(totalsHtml === '') totalsHtml = '<p style="text-align:right; font-weight:bold;">No quantities selected.</p>';

            const notesContentForPrint = details.generalNotes ? details.generalNotes.replace(/\n/g, '<br>') : (forPdfOrWord ? '<i>No notes provided.</i>' : '<i>'+currentLangSet.emptySummaryText+'</i>');
            
            // This is the core HTML content that will be styled differently for browser print vs. PDF/Word wrapper
            const mainPrintableHtml = `
                <header class="print-header" style="box-sizing:border-box; text-align:center; margin-bottom:10px; border-bottom:1.5px solid #000; padding-bottom:6px;">
                    <img src="${logoSrcToUse}" alt="Selda Mediterranean Logo" class="print-logo" style="max-width:80px; height:auto; margin-bottom:6px; display:block; margin-left:auto; margin-right:auto;">
                    <h1 style="font-size:13pt; font-weight:700; margin-top:4px; margin-bottom:8px; text-align:center; color:#333;">${enLangSet.orderFormTitle}</h1>
                    <div class="print-order-info" style="display:flex; justify-content:space-between; align-items:center; width:100%; margin-top:4px; font-size:8.5pt; box-sizing:border-box;">
                        <span style="margin:1px 0;"><strong>${enLangSet.orderNoLabel}</strong> ${details.orderNo}</span>
                        <span style="margin:1px 0;"><strong>${enLangSet.orderDateLabel}</strong> ${details.formattedOrderDate}</span>
                    </div>
                </header>
                <section class="print-section" style="margin-bottom:8px; box-sizing:border-box;">
                    <h2 style="font-size:10pt; font-weight:700; border-bottom:1px solid #ccc; padding-bottom:2px; margin-top:12px; margin-bottom:6px; text-align:left; color:#333;">BRANCH INFORMATION</h2>
                    <div class="print-info-compact" style="font-size:8.5pt; box-sizing:border-box;">
                        <div class="info-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:2px 12px;">
                            <p style="margin:1.5px 0;"><strong>${enLangSet.branchNameLabel}</strong> ${details.branchName}</p>
                            <p style="margin:1.5px 0;"><strong>${enLangSet.authorizedPersonLabel}</strong> ${details.senderName}</p>
                            <p style="margin:1.5px 0;"><strong>${enLangSet.contactPhoneLabel}</strong> ${details.contactPhone}</p>
                            <p style="margin:1.5px 0;"><strong>${enLangSet.requestedDeliveryDateLabel}</strong> ${details.formattedDeliveryDate}</p>
                        </div>
                    </div>
                </section>
                <section class="print-section" style="margin-bottom:8px; box-sizing:border-box;">
                    <h2 style="font-size:10pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:2px;margin-top:12px;margin-bottom:6px;text-align:left;color:#333;">REQUESTED PRODUCTS</h2>
                    <table class="print-product-table" style="width:100%;border-collapse:collapse;margin-top:6px;font-size:8pt;box-sizing:border-box;">
                        <thead style="font-size:8pt;"><tr style="page-break-inside:avoid;">
                           ${headerHtml}
                        </tr></thead>
                        <tbody style="font-size:8pt;">${productRowsHtml.replace(/<td/g,'<td style="border:1px solid #ccc;padding:3px 5px;text-align:left;vertical-align:top;box-sizing:border-box;word-break:break-word;"')}</tbody>
                    </table>
                    <div class="print-totals" style="margin-top:8px;padding-top:8px;border-top:1px solid #666;font-size:8.5pt;box-sizing:border-box;">
                        ${totalsHtml}
                    </div>
                </section>
                <div class="print-notes-signatures-footer-group" style="padding-top: 10px; page-break-inside: avoid !important; flex-shrink: 0; ${forPdfOrWord ? 'margin-top: 20px;' : 'margin-top: auto;'}">
                    <section class="print-section" style="margin-bottom:8px;box-sizing:border-box;">
                        <h2 style="font-size:10pt;font-weight:700;border-bottom:1px solid #ccc;padding-bottom:2px;margin-top:12px;margin-bottom:6px;text-align:left;color:#333;">${enLangSet.generalNotesTitleHeader}</h2>
                        <div class="print-notes" style="border:none;border-top:1px solid #ccc;border-bottom:1px solid #ccc;padding:6px 0;min-height:30px;margin-top:4px;font-size:8pt;white-space:pre-wrap;word-break:break-word;box-sizing:border-box;">${notesContentForPrint}</div>
                    </section>
                    <div style="height:1em;page-break-before:auto;"></div>
                    <div class="print-signatures" style="margin-top:25px;display:flex;justify-content:space-between;font-size:8pt;align-items:flex-end;box-sizing:border-box;">
                        <div class="signature-block-print" style="width:45%;text-align:center;box-sizing:border-box;"><p style="margin:0;padding-top:12px;border-top:1px solid #666;">Delivered By (Signature)</p></div>
                        <div class="signature-block-print" style="width:45%;text-align:center;box-sizing:border-box;"><p style="margin:0;padding-top:12px;border-top:1px solid #666;">Received By (Signature)</p></div>
                    </div>
                    <footer class="print-footer" style="text-align:center;margin-top:15px;padding-top:6px;border-top:1px dashed #aaa;font-size:7pt;color:#555;box-sizing:border-box;">
                        <p>${companyNamePrint}</p>
                        <p>Address: ${COMPANY_ADDRESS_PRINT} | Phone: ${COMPANY_PHONE_PRINT}</p>
                    </footer>
                </div>`;

            if (forPdfOrWord) {
                // For PDF/Word, wrap the content in #captureForPdfOrWord with pixel dimensions
                const A4_WIDTH_PX_FOR_CANVAS = 794; // Approx 210mm at 96DPI
                const PAGE_MARGIN_PX_FOR_CANVAS = 38; // Approx 10mm at 96DPI
                const pdfWordCaptureWrapperStyle = `width:${A4_WIDTH_PX_FOR_CANVAS}px; padding:${PAGE_MARGIN_PX_FOR_CANVAS}px; background:white; font-family:Arial,sans-serif; font-size:8pt; color:#000; box-sizing:border-box; margin:0 auto;`;
                return `<div id="captureForPdfOrWord" style="${pdfWordCaptureWrapperStyle}">${mainPrintableHtml}</div>`;
            } else {
                // For browser print, inject directly into #printAreaContent
                // The #printAreaContent itself is styled by @media print to be flex, min-height, etc.
                const printAreaContentEl = document.getElementById('printAreaContent');
                if (printAreaContentEl) {
                    printAreaContentEl.innerHTML = mainPrintableHtml;
                }
                return mainPrintableHtml; // Or void, as it modified DOM. For consistency, return.
            }
        }

        async function generatePdfBlob() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                console.error("jsPDF kütüphanesi yüklenemedi."); alert("PDF oluşturma kütüphanesi (jsPDF) yüklenemedi."); return null;
            }
            if (typeof html2canvas === 'undefined') {
                console.error("html2canvas kütüphanesi yüklenemedi."); alert("PDF oluşturma kütüphanesi (html2canvas) yüklenemedi."); return null;
            }

            const { jsPDF } = window.jspdf;
            const completeHtmlForPdf = generatePrintContent(true); // Get HTML wrapped with #captureForPdfOrWord
            
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute'; 
            tempDiv.style.left = '-99999px'; // Further off-screen
            tempDiv.style.top = '0px';
            // tempDiv.style.width = '210mm'; // Optional: provide a context width for the capture div.
                                        // #captureForPdfOrWord already has pixel width, so this might not be needed.
            document.body.appendChild(tempDiv);
            tempDiv.innerHTML = completeHtmlForPdf; // Add the wrapped HTML
            const elementToCapture = tempDiv.querySelector('#captureForPdfOrWord');

            if (!elementToCapture) {
                console.error("#captureForPdfOrWord element not found in tempDiv");
                document.body.removeChild(tempDiv);
                return null;
            }
            
            try {
                const canvas = await html2canvas(elementToCapture, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    width: elementToCapture.offsetWidth, // Explicitly use offsetWidth
                    height: elementToCapture.offsetHeight // Explicitly use offsetHeight
                });
                document.body.removeChild(tempDiv);

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                
                const imgProps = pdf.getImageProperties(imgData);
                const pdfPageWidth = pdf.internal.pageSize.getWidth();
                const pdfPageHeight = pdf.internal.pageSize.getHeight();
                
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;

                // Calculate the aspect ratio of the image and the PDF page
                const imgAspectRatio = imgWidth / imgHeight;
                const pdfPageAspectRatio = pdfPageWidth / pdfPageHeight;

                let finalImgWidthOnPdf, finalImgHeightOnPdf;

                // Scale image to fit PDF page width, height will adjust by aspect ratio
                finalImgWidthOnPdf = pdfPageWidth;
                finalImgHeightOnPdf = pdfPageWidth / imgAspectRatio;


                if (finalImgHeightOnPdf <= pdfPageHeight) {
                    // Image fits on one page
                    pdf.addImage(imgData, 'PNG', 0, 0, finalImgWidthOnPdf, finalImgHeightOnPdf);
                } else {
                    // Image is taller than one page, needs pagination
                    let numPages = Math.ceil(finalImgHeightOnPdf / pdfPageHeight);
                    let yPositionOnCanvas = 0; // Current Y position on the source canvas (imgData)
                    
                    // Calculate how much of the source canvas height corresponds to one PDF page height
                    const singlePdfPageHeightOnCanvas = (pdfPageHeight / finalImgHeightOnPdf) * imgHeight;


                    for (let i = 0; i < numPages; i++) {
                        if (i > 0) pdf.addPage();
                        
                        let sliceHeightOnCanvas = Math.min(singlePdfPageHeightOnCanvas, imgHeight - yPositionOnCanvas);
                        if (sliceHeightOnCanvas <= 0) break;

                        const tempPageCanvas = document.createElement('canvas');
                        tempPageCanvas.width = imgWidth; // Source canvas width
                        tempPageCanvas.height = sliceHeightOnCanvas;
                        const tempPageCtx = tempPageCanvas.getContext('2d');
                        
                        // Draw the slice from the original large canvas to the temporary small canvas
                        // The original `canvas` object from html2canvas can be used here directly
                        tempPageCtx.drawImage(canvas, 
                                              0, yPositionOnCanvas, // sx, sy (source)
                                              imgWidth, sliceHeightOnCanvas, // sWidth, sHeight (source)
                                              0, 0, // dx, dy (destination)
                                              imgWidth, sliceHeightOnCanvas); // dWidth, dHeight (destination)
                        
                        const pageImgData = tempPageCanvas.toDataURL('image/png');
                        pdf.addImage(pageImgData, 'PNG', 0, 0, pdfPageWidth, pdfPageHeight); // Stretch slice to fill PDF page (or maintain aspect)
                        
                        yPositionOnCanvas += sliceHeightOnCanvas;
                        if (yPositionOnCanvas >= imgHeight) break;
                    }
                }
                return pdf.output('blob');
            } catch (error) {
                console.error("PDF oluşturma hatası:", error);
                if (tempDiv.parentElement) document.body.removeChild(tempDiv);
                return null;
            }
        }


        async function generateAndDownloadWord() {
            if (typeof htmlDocx === 'undefined' || typeof saveAs === 'undefined') {
                console.error("html-docx-js veya FileSaver kütüphanesi yüklenemedi."); alert("Word oluşturma kütüphaneleri yüklenemedi."); return;
            }
            const langSet = translations[currentLanguage] || translations.en;
            shareModalMessage.textContent = "Word dosyası oluşturuluyor...";
            shareButtonsContainer.style.display = 'none';
            try {
                const completeHtmlForWord = generatePrintContent(true); // Get HTML wrapped with #captureForPdfOrWord
                const tempDiv = document.createElement('div'); 
                tempDiv.innerHTML = completeHtmlForWord;
                // html-docx-js expects the innerHTML of the element to convert
                const contentToConvert = tempDiv.querySelector('#captureForPdfOrWord').innerHTML;

                const converted = htmlDocx.asBlob(contentToConvert, {
                    orientation: 'portrait',
                    margins: { top: 720, right: 720, bottom: 720, left: 720, header: 0, footer: 0, gutter: 0 } // 1 inch margins
                });
                const today = new Date();
                const formattedDate = formatDateForFileName(today);
                const branchName = getCurrentBranchName().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
                const fileName = `${branchName}_${formattedDate}.docx`;
                saveAs(converted, fileName);
                shareModalMessage.textContent = langSet.shareModalMessageReady;
            } catch (error) {
                console.error("Word oluşturma hatası:", error);
                shareModalMessage.textContent = langSet.wordGenerationFailed;
            } finally {
                shareButtonsContainer.style.display = 'block';
            }
        }

        function getOrderSummaryAsText() {
            const details = getOrderDetails(true);
            const langSet = translations[currentLanguage] || translations.en;
            let text = `${langSet.orderFormTitle}\n------------------------------------\n`;
            text += `${langSet.orderNoLabel} ${details.orderNo}\n`;
            text += `${langSet.orderDateLabel} ${details.displayOrderDate}\n`;
            text += `${langSet.authorizedPersonLabel} ${details.senderName}\n`;
            text += `${langSet.branchNameLabel} ${details.branchName}\n`;
            text += `${langSet.requestedDeliveryDateLabel} ${details.displayDeliveryDate}\n`;
            text += `${langSet.contactPhoneLabel} ${details.contactPhone}\n`;
            text += `------------------------------------\n${langSet.orderSummaryTitle.toUpperCase()}:\n`;
            if (details.summaryItems.length > 0) {
                details.summaryItems.forEach(item => { text += `- ${item.name}: ${item.quantity}\n`; });
            } else { text += `${langSet.emptySummaryText}\n`; }
            text += `\n------------------------------------\n`;

            let usedUnitsInSummary = { lb: false, quart: false, pcs: false };
             details.summaryItems.forEach(item => {
                if (item.quantity.includes(langSet.summaryUnitLB)) usedUnitsInSummary.lb = true;
                if (item.quantity.includes(langSet.summaryUnitQuart)) usedUnitsInSummary.quart = true;
                if (item.quantity.includes(langSet.summaryUnitPCS) || item.quantity.includes(langSet.summaryUnitKunefeSmall) || item.quantity.includes(langSet.summaryUnitKunefeLarge)) usedUnitsInSummary.pcs = true;
            });

            if (usedUnitsInSummary.lb) text += `${langSet.totalLbLabel} ${details.totalLbText}\n`;
            if (usedUnitsInSummary.quart) text += `${langSet.totalQuartLabel} ${details.totalQuartText}\n`;
            if (usedUnitsInSummary.pcs) text += `${langSet.totalPcsLabel} ${details.totalPcsText}\n`;
            
            text += `\n${langSet.generalNotesTitle.toUpperCase()}:\n${details.generalNotes || langSet.emptySummaryText}\n`; // Display notes or "empty"
            text += `------------------------------------\n`;
            return text;
        }

        function initializeMainForm(){
            if (mainFormInitialized) return;
            assignMainFormDOMElements();
            mainFormInitialized = true;

            populateBranchSelect();
            loadFormSettings();
            setInitialDates();
            setFooterInfo();
            setDeveloperSignature();
            renderProducts();
            updateOrderSummary();

            let orderCounter = 0;
            try { orderCounter = parseInt(localStorage.getItem(LS_ORDER_COUNTER)) || 0; } catch(e) { console.warn("Sipariş sayacı okuma hatası:", e); }
            orderCounter++;
            try { localStorage.setItem(LS_ORDER_COUNTER, orderCounter); } catch(e) { console.warn("Sipariş sayacı kaydetme hatası:", e); }

            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            if(orderNoInput) orderNoInput.value = `S${year}${month}${day}-${orderCounter.toString().padStart(3, '0')}`;


            if(orderSenderNameInput) orderSenderNameInput.addEventListener('input', () => saveFormSetting(LS_SENDER_NAME, orderSenderNameInput.value));
            if(contactPhoneInput) contactPhoneInput.addEventListener('input', () => saveFormSetting(LS_CONTACT_PHONE, contactPhoneInput.value));
            if(branchSelect) branchSelect.addEventListener('change', () => saveFormSetting(LS_BRANCH_SELECT_VALUE, branchSelect.value));
            if(manualBranchInput) manualBranchInput.addEventListener('input', () => saveFormSetting(LS_MANUAL_BRANCH_VALUE, manualBranchInput.value));
            if(manualBranchCheckbox) manualBranchCheckbox.addEventListener('change', () => { updateBranchInputState(); saveFormSetting(LS_MANUAL_BRANCH_ENABLED, manualBranchCheckbox.checked); });
            
            if(orderDateInput) orderDateInput.addEventListener('change', () => saveFormSetting(LS_ORDER_DATE, orderDateInput.value));
            if(deliveryDateInput) deliveryDateInput.addEventListener('change', () => saveFormSetting(LS_DELIVERY_DATE, deliveryDateInput.value));

            if (mainFormLangTrBtn) mainFormLangTrBtn.addEventListener('click', () => setLanguage('tr'));
            if (mainFormLangEnBtn) mainFormLangEnBtn.addEventListener('click', () => setLanguage('en'));

            if (printButton) printButton.onclick = function() { 
                if(!mainFormInitialized || !validateOrderForm()) return; 
                generatePrintContent(false); // This injects HTML into #printAreaContent
                window.print(); 
            };

            if (sendEmailBtn) sendEmailBtn.addEventListener('click', function() {
                if(!mainFormInitialized || !validateOrderForm()) return;
                const details = getOrderDetails(true);
                const emailBody = getOrderSummaryAsText();
                const subject = `New Order Request - No: ${details.orderNo} - Branch: ${details.branchName} - By: ${details.senderName}`;
                window.location.href = `mailto:${EMAIL_RECIPIENT}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            });

            if (shareButton) shareButton.addEventListener('click', async function() {
                if(!mainFormInitialized || !validateOrderForm()) return;
                const langSet = translations[currentLanguage] || translations.en;
                shareOptionsModal.style.display = 'flex';
                shareModalMessage.textContent = langSet.shareModalMessage;
                shareButtonsContainer.style.display = 'none';
                const pdfBlob = await generatePdfBlob();
                let pdfFileForSharing = null;

                const today = new Date();
                const formattedDate = formatDateForFileName(today);
                const branchName = getCurrentBranchName().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
                const baseFileName = `${branchName}_${formattedDate}`;


                if (pdfBlob) {
                    pdfFileForSharing = new File([pdfBlob], `${baseFileName}.pdf`, { type: 'application/pdf' });
                    downloadPdfButton.onclick = () => { const url = URL.createObjectURL(pdfBlob); const a = document.createElement('a'); a.href = url; a.download = `${baseFileName}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };
                    shareModalMessage.textContent = langSet.shareModalMessageReady;
                } else { shareModalMessage.textContent = langSet.pdfGenerationFailed; }
                shareButtonsContainer.style.display = 'block';
                if (navigator.share && pdfFileForSharing) {
                    try {
                        const details = getOrderDetails();
                        await navigator.share({ title: `Order Form - ${details.orderNo}`, text: `Order Form: ${details.orderNo} - ${details.branchName}`, files: [pdfFileForSharing] });
                        shareOptionsModal.style.display = 'none';
                    } catch (err) {
                        console.error('Share failed:', err.message);
                        if (err.name !== 'AbortError') { shareModalMessage.textContent += ` (${langSet.webShareNotSupported})`; }
                    }
                } else if (pdfBlob) { shareModalMessage.textContent = langSet.shareModalMessageReady + (navigator.share ? '' : ` (${langSet.webShareNotSupported})`); }
            });

            if (closeShareModalButton) closeShareModalButton.addEventListener('click', () => { shareOptionsModal.style.display = 'none'; });
            if (downloadWordButton) downloadWordButton.addEventListener('click', generateAndDownloadWord);
            window.addEventListener('click', (event) => { if (event.target === shareOptionsModal) shareOptionsModal.style.display = "none"; });
        }

        function onPageLoad() {
            console.log('DOM fully loaded and parsed.');
            assignLoginDOMElements();
            loadLanguage();
            loadRememberMe();

            if (!checkAuth()) {
                if (loginButton) loginButton.addEventListener('click', handleLogin);
                if (passwordInput) passwordInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); handleLogin(); }});
                if (usernameInput) usernameInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); if(passwordInput) passwordInput.focus(); }});
            }
        }


        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', onPageLoad);
        } else {
            onPageLoad();
        }

        console.log('PWA Script: Attempting to register Service Worker...');
        if ('serviceWorker' in navigator) {
            console.log('PWA Script: Service Worker API is available in navigator.');
            window.addEventListener('load', () => {
                console.log('PWA Script: Window (including all resources) fully loaded. Registering Service Worker from ./sw.js');
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then((registration) => {
                        console.log('PWA Script: Service Worker registered successfully! Scope is: ', registration.scope);
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            if (installingWorker) {
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            console.log('PWA Script: New content is available; please refresh.');
                                        } else {
                                            console.log('PWA Script: Content is cached for offline use (basic).');
                                        }
                                    }
                                };
                            }
                        };
                    })
                    .catch((registrationError) => {
                        console.error('PWA Script: Service Worker registration FAILED: ', registrationError);
                    });
            });
        } else {
            console.warn('PWA Script: Service Worker is NOT supported by this browser.');
        }
    })();
    </script>
</body>
</html>
